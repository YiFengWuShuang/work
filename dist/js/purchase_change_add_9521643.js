var formTip='<div id="formTip" class="formTip"></div>',$itemTips=$(".item-tips"),container=$(".contarin"),orderReviseInfoCon=$("#orderReviseInfoCon"),_vParams=JSON.parse(decodeURI(getQueryString("param"))),_reg=/^(\s|\S)+(jpg|jpeg|png|gif|bmp|JPG|JPEG|PNG|GIF|BMP)+$/;_vParams.changeType=1;var Lists=function(){this.init()};Lists.prototype={init:function(){var e=this;e._files=[],e._lineLists=[],e._othersCost=[],e.totals=0,e.load=!1,requestFn("B03_POCType",function(a){"0"==a.errorCode&&(e.changeType=a.dataSet.data.detail)}),requestFn("B02_LogisticsType",function(a){"0"==a.errorCode&&(e.logisticsType=a.dataSet.data.detail)}),requestFn("B02_InvoiceType",function(a){"0"==a.errorCode&&(e.invoiceType=a.dataSet.data.detail)}),e.start()},orderBaseInfo:function(){var e=this,a="",n={serviceId:"B03_getPurchaseOrderInfo",companyId:_vParams.companyId,poId:_vParams.poId,commonParam:commonParam(),token:_vParams.token,secretNumber:_vParams.secretNumber};return $.ajax({type:"POST",async:!1,url:config.serviceUrl,data:"param="+JSON.stringify(n),success:function(n){n=n||{},n.success&&(e.orderInfo=n.purchaseOrderInfo,a+='<h2 class="m-title">变更信息</h2><div class="item-wrap">	<ul>		<li><span>所属公司：</span><b>'+e.orderInfo.companyName+"</b></li>		<li><span>采购单号：</span><b>"+e.orderInfo.poFormNo+"</b></li>		<li><span>内部采购单号：</span><b>"+e.orderInfo.poInsideNo+"</b></li>		<li><span>变更类型：</span>"+enumFn(e.changeType,_vParams.changeType)+"</li>		<li><span>变更人：</span>"+e.orderInfo.auditname+"</li>		<li><span>变更日期：</span>"+transDate((new Date).getTime())+"</li>	</ul></div>")}}),a},fileList:function(){var e=this;if(e.load){var a={secretNumber:_vParams.secretNumber,token:_vParams.token,serviceId:"B01_findFileList",companyId:_vParams.companyId,commonParam:commonParam(),fileSource:"1",searchType:"2",id:_vParams.poId,docType:10};$.ajax({type:"POST",url:config.serviceUrl,data:"param="+JSON.stringify(a),success:function(a){if(a=a||{},a.success){for(var n=a.fileList,s=0,t=n.length;t>s;s++)""!=n[s].fileName&&$(".files").eq(s).html('<span>附件：</span><a href="'+n[s].fileUrl+'"><i class=i-'+(_reg.test(n[s].fileName)?"image":"word")+"></i>"+n[s].fileName+"</a>").show();e._files=n}}})}},prodBodyInfo:function(){var e=this,a="",n={serviceId:"B03_findPoLineList",companyId:_vParams.companyId,poId:_vParams.poId,commonParam:commonParam(),token:_vParams.token,secretNumber:_vParams.secretNumber};return $.ajax({type:"POST",async:!1,url:config.serviceUrl,data:"param="+JSON.stringify(n),success:function(n){if(n=n||{},n.success){var s=n.poLineList;e._lineLists=s,a='<h2 class="m-title">采购明细</h2>';for(var t=0,i=s.length;i>t;t++)a+='<div class="item-wrap" data-index="'+t+'">	<ul>		<li class="prodCode"><span>物料编码：</span><b>'+s[t].prodCode+"</b></li>		<li><span>物料名称：</span><p>"+s[t].prodName+"</p></li>		<li><section><span>数量：</span><em>"+s[t].purchaseQty+"</em>"+s[t].purchaseUnitName+"/<em>"+s[t].valuationQty+"</em>"+s[t].valuationUnitName+"</section><section><span>预交期：</span><em>"+transDate(s[t].expectedDelivery)+'</em></section></li>		<li class="changeItem"><section><span>变更：</span><em>'+(""==s[t].vPurchaseQty?0:s[t].vPurchaseQty)+"</em>"+s[t].purchaseUnitName+"/<em>"+(""==s[t].vValuationQty?0:s[t].vValuationQty)+"</em>"+s[t].valuationUnitName+"</section><section><span>预交期：</span><em>"+transDate(s[t].expectedDelivery)+'</em></section></li>		<li class="price"><span>单价：</span>&yen; '+s[t].taxPrice+"/"+s[t].valuationUnitName+"</li>		<li><span>备注：</span><p>"+s[t].remark+'</p></li>		<li class="files"><span>附件：</span></li>		<li class="subtotal"><span>小计：</span><b>&yen; '+formatMoney(s[t].taxLineTotal)+'</b></li>		<li class="changeItem changeLineTotal"><span>变更金额：</span>&yen; '+formatMoney(s[t].vTaxLineTotal)+"</li>	</ul></div>";e.load=!0,setTimeout(function(){container.show(),fnTip.hideLoading()},0)}else container.show().html('<p style="text-align:center;">'+n.errorMsg+"</p>"),fnTip.hideLoading()}}),a},othersCost:function(){var e=this,a="";if(e.load){var n={token:_vParams.token,secretNumber:_vParams.secretNumber,serviceId:"B03_findPoOtherCostList",companyId:_vParams.companyId,poId:_vParams.poId,commonParam:commonParam()};$.ajax({type:"POST",url:config.serviceUrl,async:!1,data:"param="+JSON.stringify(n),success:function(n){if(n=n||{},n.success){var s=n.poOtherCostList;e._othersCost=s,a='<h2 class="m-title">其他费用</h2><div class="item-wrap"><ul>';for(var t=0,i=s.length;i>t;t++)a+="<li><span>"+s[t].costName+"：</span><b>&yen; "+formatMoney(s[t].costAmount)+'</b><b class="dj"><em class="money" data-money="'+(""==s[t].vCostAmount?s[t].costAmount:s[t].vCostAmount)+'">'+(""==s[t].vCostAmount?"":formatMoney(s[t].vCostAmount))+"</em></b></li>";a+='<li id="othersCostSubtotal" class="subtotal"><span>小计：</span><b>&yen; '+formatMoney(e.orderInfo.cOtherCostTotal)+'</b></li><li id="changeCost" class="response changeLineTotal"><span>变更费用：</span>&yen; '+formatMoney(e.orderInfo.vOtherCostTotal)+"</li></ul></div>",$("#othersCost").html(a)}}})}},initSelect3:function(e,a,n){$(e).select3({allowClear:!0,items:a,placeholder:"请选择",showSearchInputInDropdown:!1,value:n})},start:function(){var e=this,a=document.getElementById("orderHeadInfo"),n=document.getElementById("prodBodyInfo");a.innerHTML=e.orderBaseInfo(),n.innerHTML=e.prodBodyInfo(),e.fileList(),e.othersCost(),$(".item-total").html("变更前总金额：&yen;"+formatMoney(e.orderInfo.cTotalAmount)).show(),$(".item-total-dj").html("变更后总金额：&yen;"+formatMoney(e.orderInfo.vTotalAmount)).show(),bottomBar(["share"],e.orderInfo.auditid,"","提交变更"),container.on("click","a.item-link",function(){var a=$(this),n=a.attr("name"),s=$body.scrollTop();switch(n){case"payInfo":orderReviseInfoCon.html(e.payInfo(s));break;case"remark":orderReviseInfoCon.html(e.remark(s));break;case"changeCause":orderReviseInfoCon.html(e.changeCause(s)),e.POCReasonType()}$body.scrollTop(0),container.addClass("contarinEdit"),$("#jBottom").addClass("m-bottom-hide")}).on("click",".btn-wrap .btnB",function(){var a=$(this),n=a.attr("data-scrollTop");if(a.is("#saveChangeCause")){var s=reEnumFn(e.pocReasonType,$("#changeCause").select3("value"));$("#changeCauseVal1").val(s),$("#changeCauseVal2").val($("#intRemarks").val())}container.removeClass("contarinEdit"),$("#jBottom").removeClass("m-bottom-hide"),setTimeout(function(){$body.scrollTop(n)},200)}),e.submitFn()},changeCause:function(){var e='<div class="m-item m-item-select">	<h2 class="m-title">变更类型：</h2>	<div id="changeCause" class="select3-input"></div></div><div class="m-item">	<h2 class="m-title">变更原因：</h2>	<div class="item-wrap int-remarks">		<textarea name="" id="intRemarks" placeholder="在此处录入变更的备注和说明"></textarea>	</div></div><div class="btn-wrap">	<a href="javascript:;" id="saveChangeCause" class="btnB">保存说明</a></div>';return e},POCReasonType:function(){var e=this,a=[];requestFn("B03_POCReasonType",function(n){if("0"==n.errorCode){{var s=n.dataSet.data.detail;s.length}e.pocReasonType=s,s.forEach(function(e){a.push(e.Value)})}}),e.initSelect3("#changeCause",a,"取消订单")},payInfo:function(e){var a=this,n=a.orderInfo,s='<ul class="payInfoList"><li><span>交易条件：</span><p>'+n.conditionName+"</p></li><li><span>物流方式：</span><p>"+enumFn(a.logisticsType,n.logisticsType)+("3"==n.logisticsType?"（自提点："+n.address+"）":"")+"</p></li><li><span>收货地址：</span><p>"+n.address+"；"+(""==n.mobile?"":"<br>电话："+n.mobile)+"</p></li><li><span>付款条件：</span><p>"+n.payWayName+"</p></li><li><span>发票类型：</span><p>"+enumFn(a.invoiceType,n.invoiceType)+"</p></li><li><span>发票抬头：</span><p>"+n.invoiceHeader+"</p></li><li><span>发票类容：</span><p>"+n.invoiceContent+'</p></li></ul><div class="btn-wrap"><a href="javascript:;" class="btnB" data-scrollTop="'+e+'">完成</a></div>';return s},remark:function(e){for(var a=this,n='<div class="remarks-wrap"><div id="provisions" class="item-wrap clause">	<h2>补充条款：</h2>	<p>'+a.orderInfo.agreement+'</p></div><div id="taRemarks" class="item-wrap taRemarks">	<h2>备注信息：</h2>	<p>'+a.orderInfo.remark+'</p></div><div id="files" class="item-wrap attachment">	<h2>订单附件：</h2>',s=0;s<a._files.length;s++)n+='<p><a href="'+a._files[s].fileUrl+'"><i class=i-'+(_reg.test(a._files[s].fileName)?"image":"word")+"></i>"+a._files[s].fileName+"</a></p>";return n+='</div></div></div><div class="btn-wrap"><a href="javascript:;" id="saveRemark" class="btnB" data-scrollTop="'+e+'">完成</a></div>'},popup:function(e,a,n,s,t){new Popup({type:e,title:a,content:n,ok:"确定",cancel:"取消",closeCallBack:s,okCallBack:t})},submitFn:function(){function e(e,a){$.ajax({type:"POST",url:config.serviceUrl,data:"param="+JSON.stringify(s(e)),success:function(e){e=e||{},e.success?a&&a():fnTip.error(2e3)}})}var a=this,n=commonParam();n.secretKey="1",n.joinUpCode="1";var s=function(e){return{companyId:_vParams.companyId,commonParam:n,token:_vParams.token,secretNumber:_vParams.secretNumber,pocId:_vParams.id,serviceId:e}};$body.on("click",".bottom-btn-confirm",function(){a.popup("confirm","","确定提交变更吗？",function(){},function(){e("B03_submitPoChange",function(){fnTip.success(2e3,"提交成功")})})}),$body.on("click",".bottom-btn-cancel",function(){a.popup("confirm","","确定取消变更吗？",function(){},function(){e("B03_cancelPoChange",function(){fnTip.success(2e3,"取消成功")})})})}};