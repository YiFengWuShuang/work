var formTip='<div id="formTip" class="formTip"></div>',$itemTips=$(".item-tips"),container=$(".contarin"),orderReviseInfoCon=$("#orderReviseInfoCon"),_vParams=JSON.parse(decodeURI(getQueryString("param"))),_reg=/^(\s|\S)+(jpg|jpeg|png|gif|bmp|JPG|JPEG|PNG|GIF|BMP)+$/,Lists=function(){this.init()};Lists.prototype={init:function(){var a=this;a._files=[],a._lineLists=[],a._othersCost=[],a.totals=0,a.load=!1,a.memberId="",requestFn("B03_POCType",function(e){"0"==e.errorCode&&(a.changeType=e.dataSet.data.detail)}),requestFn("B03_POCReasonType",function(e){"0"==e.errorCode&&(a.reasonType=e.dataSet.data.detail)}),requestFn("B02_LogisticsType",function(e){"0"==e.errorCode&&(a.logisticsType=e.dataSet.data.detail)}),requestFn("B02_InvoiceType",function(e){"0"==e.errorCode&&(a.invoiceType=e.dataSet.data.detail)}),a.start(),$(".item-total").html("变更前总金额：&yen;"+formatMoney(a.totals)).show(),$(".item-total-dj").html("变更后总金额：&yen;"+formatMoney(a.reCostTotalFn())).show()},orderBaseInfo:function(){var a=this,e="",n={serviceId:"B03_getSocNoticeInfo",companyId:_vParams.companyId,id:_vParams.id,commonParam:commonParam(),token:_vParams.token,secretNumber:_vParams.secretNumber};return $.ajax({type:"POST",async:!1,url:config.serviceUrl,data:"param="+JSON.stringify(n),success:function(n){n=n||{},n.success&&(a.orderInfo=n.socChange,e+='<h2 class="m-title">变更信息</h2><div class="item-wrap">	<ul>		<li><span>平台变更单号：</span><b>'+a.orderInfo.socFormNo+"</b></li>		<li><span>内部变更单号：</span><b>"+a.orderInfo.soInsideNo+"</b></li>		<li><span>客户简称：</span>"+a.orderInfo.companyAbbr+"</li>		<li><span>变更类型：</span>"+enumFn(a.changeType,a.orderInfo.changeType)+"</li>		<li><span>变更日期：</span>"+transDate(a.orderInfo.socFormDate)+"</li>		<li><span>变更原因：</span>"+enumFn(a.reasonType,a.orderInfo.changeReason)+"</li>		<li><span>变更备注：</span>"+a.orderInfo.remark+"</li>	</ul></div>")}}),e},prodBodyInfo:function(){var a=this,e="",n={serviceId:"B03_findSocNoticeLineList",companyId:_vParams.companyId,id:_vParams.id,commonParam:commonParam(),token:_vParams.token,secretNumber:_vParams.secretNumber};return $.ajax({type:"POST",async:!1,url:config.serviceUrl,data:"param="+JSON.stringify(n),success:function(n){if(n=n||{},n.success){var s=n.socChangeLine;a._lineLists=s,e='<h2 class="m-title">销售明细</h2>';for(var t=0,o=s.length;o>t;t++)e+='<div class="item-wrap" data-index="'+t+'">	<ul>		<li class="prodCode"><span>物料编码：</span><b>'+s[t].prodCode+"</b></li>		<li><span>物料详细：</span><p>"+s[t].prodName+" "+s[t].prodDesc+"</p></li>		<li><section><span>数量：</span><em>"+s[t].salesQty+"</em>"+s[t].saleUnitName+"/<em>"+s[t].valuationQty+"</em>"+s[t].valuationUnitName+"</section><section><span>交期：</span><em>"+transDate(s[t].expectedDelivery)+'</em></section></li>		<li class="changeItem"><section><span>变更：</span><em>'+s[t].changeQty+"</em>"+s[t].saleUnitName+"/<em>"+s[t].changeValuationQty+"</em>"+s[t].valuationUnitName+"</section><section><span>交期：</span><em>"+transDate(s[t].changeExpectedDelivery)+'</em></section></li>		<li class="price"><span>单价：</span>&yen; '+formatMoney(1==a.orderInfo.isContainTax?s[t].taxPrice:s[t].price)+"/"+s[t].valuationUnitName+"</li>		<li><span>备注：</span><p>"+s[t].remark+'</p></li>		<li class="files"><span>附件：</span></li>		<li class="subtotal"><span>小计：</span><b>&yen; '+formatMoney(s[t].taxLineTotal)+"</b></li>"+(""!=s[t].changeTaxLineTotal?'<li class="changeItem changeLineTotal" data-changeTotal="'+s[t].changeTaxLineTotal+'"><span>变更金额：</span>&yen; '+formatMoney(s[t].changeTaxLineTotal)+"</li>":"")+"	</ul></div>",a.totals+=parseInt(s[t].taxLineTotal,10);a.load=!0,setTimeout(function(){container.show(),fnTip.hideLoading()},0)}else container.show().html('<p style="text-align:center;">'+n.errorMsg+"</p>"),fnTip.hideLoading()}}),e},othersCost:function(){var a=this,e="",n=0,s=0,t=!1;if(a.load){var o={token:_vParams.token,secretNumber:_vParams.secretNumber,serviceId:"B03_findSocNoticeOtherCostList",companyId:_vParams.companyId,socId:_vParams.id,commonParam:commonParam()};$.ajax({type:"POST",async:!1,url:config.serviceUrl,data:"param="+JSON.stringify(o),success:function(o){if(o=o||{},o.success){var i=o.costList;a._othersCost=i,e='<h2 class="m-title">其他费用</h2><div class="item-wrap" data-index="0"><ul>';for(var r=0,c=i.length;c>r;r++)e+="<li><span>"+i[r].costName+"：</span><b>&yen; "+formatMoney(i[r].costAmount)+'</b><b class="dj"><em class="money" data-money="'+(""==i[r].changeCostAmount?i[r].costAmount:i[r].changeCostAmount)+'">'+(""==i[r].changeCostAmount?"":formatMoney(i[r].changeCostAmount))+"</em></b></li>",n+=parseInt(""==i[r].costAmount?0:i[r].costAmount,10),s+=parseInt(""==i[r].changeCostAmount?i[r].costAmount:i[r].changeCostAmount,10),""!=i[r].changeCostAmount&&(t=!0);e+='<li id="othersCostSubtotal" class="subtotal"><span>小计：</span><b>&yen; '+formatMoney(n)+'</b></li><li id="changeCost" class="response changeLineTotal" data-changeTotal="'+s+'"><span>变更费用：</span>&yen; '+formatMoney(s)+"</li></ul></div>",$("#othersCost").html(e),a.totals+=parseInt(n,10)}}})}},reCostTotalFn:function(){var a=0;return container.find(".changeLineTotal").each(function(){a+=parseInt($(this).attr("data-changeTotal"),10)}),a},initSelect3:function(a,e,n){$(a).select3({allowClear:!0,items:e,placeholder:"请选择",showSearchInputInDropdown:!1,value:n})},start:function(){var a=this,e=document.getElementById("orderHeadInfo"),n=document.getElementById("prodBodyInfo");e.innerHTML=a.orderBaseInfo(),n.innerHTML=a.prodBodyInfo(),a.othersCost(),container.on("click","a.item-link",function(){var e=$(this),n=e.attr("name"),s=$body.scrollTop();switch(n){case"payInfo":orderReviseInfoCon.html(a.payInfo(s));break;case"remark":orderReviseInfoCon.html(a.remark(s));break;case"changeCause":orderReviseInfoCon.html(a.changeCause(s)),a.POCReasonType()}$body.scrollTop(0),container.addClass("contarinEdit"),$("#jBottom").addClass("m-bottom-hide")}).on("click",".btn-wrap .btnB",function(){var e=$(this),n=e.attr("data-scrollTop");if(e.is("#saveChangeCause")){var s=reEnumFn(a.pocReasonType,$("#changeCause").select3("value"));$("#changeCauseVal1").val(s),$("#changeCauseVal2").val($("#intRemarks").val())}container.removeClass("contarinEdit"),$("#jBottom").removeClass("m-bottom-hide"),setTimeout(function(){$body.scrollTop(n)},200)})},changeCause:function(){var a='<div class="m-item m-item-select">	<h2 class="m-title">变更原因：</h2>	<div id="changeCause" class="select3-input"></div></div><div class="m-item">	<h2 class="m-title">变更说明：</h2>	<div class="item-wrap int-remarks">		<textarea name="" id="intRemarks" placeholder="在此处录入变更的备注和说明"></textarea>	</div></div><div class="btn-wrap">	<a href="javascript:;" id="saveChangeCause" class="btnB">保存说明</a></div>';return a},POCReasonType:function(){var a=this,e=[];a.reasonType.forEach(function(a){e.push(a.Value)}),a.initSelect3("#changeCause",e,"")},payInfo:function(a){var e=this,n=e.orderInfo,s='<ul class="payInfoList"><li><span>交易条件：</span><p>'+n.conditionName+"</p></li><li><span>物流方式：</span><p>"+enumFn(e.logisticsType,n.logisticsType)+("3"==n.logisticsType?"（自提点："+n.address+"）":"")+"</p></li><li><span>收货地址：</span><p>"+n.address+"；"+(""==n.mobile?"":"<br>电话："+n.mobile)+"</p></li><li><span>付款条件：</span><p>"+n.payWayName+"</p></li><li><span>发票类型：</span><p>"+enumFn(e.invoiceType,n.invoiceType)+"</p></li><li><span>发票抬头：</span><p>"+n.invoiceHeader+"</p></li><li><span>发票类容：</span><p>"+n.invoiceContent+'</p></li></ul><div class="btn-wrap"><a href="javascript:;" class="btnB" data-scrollTop="'+a+'">完成</a></div>';return s},remark:function(a){for(var e=this,n='<div class="remarks-wrap"><div id="provisions" class="item-wrap clause">	<h2>补充条款：</h2>	<p>'+e.orderInfo.agreement+'</p></div><div id="taRemarks" class="item-wrap taRemarks">	<h2>备注信息：</h2>	<p>'+e.orderInfo.poRemark+'</p></div><div id="files" class="item-wrap attachment">	<h2>订单附件：</h2>',s=0;s<e._files.length;s++)n+='<p><a href="'+e._files[s].fileUrl+'"><i class=i-'+(_reg.test(e._files[s].fileName)?"image":"word")+"></i>"+e._files[s].fileName+"</a></p>";return n+='</div></div></div><div class="btn-wrap"><a href="javascript:;" id="saveRemark" class="btnB" data-scrollTop="'+a+'">完成</a></div>'}};