var formTip='<div id="formTip" class="formTip"></div>',_vParams=JSON.parse(decodeURI(getQueryString("param"))),container=$(".contarin"),orderReviseInfoCon=$("#orderReviseInfoCon"),orderAnswerCon=$("#orderAnswerInfo"),prodAnswerCon=$("#prodAnswerInfo"),othersCostCon=$("#othersCost"),_reg=/^(\s|\S)+(jpg|jpeg|png|gif|bmp|JPG|JPEG|PNG|GIF|BMP)+$/,$scope={},$currencyData={},$taxData={},$taxListData={},$ExchangeRateData={},$conditionData={},$conditionJson={},$payWayTypeData={},$payWayData={},$logisticsType={},$AddrData={},$fileData={},addval_taxInfo=!1,addval_conditionInfo=!1,addval_paywayInfo=!1,$myRemarkVal="",privateDefultUser,orderRevise=function(){this.init()};orderRevise.prototype={init:function(){var e=this;e.orderInfo,e._lineLists=[],e._othersCost=[],e.totals=0,e.load=!1,e.memberId="",e.commonParam=JSON.stringify(commonParam()),e.tokens='"token":"'+_vParams.token+'","secretNumber":"'+_vParams.secretNumber+'"',setTimeout(function(){container.show(),fnTip.hideLoading()},0),requestFn("B02_LogisticsType",function(a){"0"==a.errorCode&&(e.logisticsType=a.dataSet.data.detail)}),requestFn("B02_InvoiceType",function(a){"0"==a.errorCode&&(e.invoiceType=a.dataSet.data.detail)}),GetUserInfo("POST",{token:_vParams.token,secretNumber:_vParams.secretNumber},function(e){"01230"==e.retCode&&(privateDefultUser=e)}),e.start()},orderBaseInfo:function(){var e=this,a="";return $.ajax({type:"POST",async:!1,url:config.serviceUrl,data:{param:'{"poAnswerId":'+_vParams.poAnswerId+',"vendorId":'+_vParams.companyId+","+e.tokens+',"serviceId":"B03_getPurchaseOrderAnswerInfo", "commonParam":'+e.commonParam+"}"},success:function(o){o=o||{},o.success&&(e.orderInfo=o.poAnswerOrderInfo,e.memberId=e.orderInfo.poManId,a+='<h2 class="m-title">基础信息</h2><div class="item-wrap">	<ul>		<li><span>平台单号：</span><b>'+e.orderInfo.poFormNo+"</b></li>		<li><span>销售单号：</span><b>"+e.orderInfo.poInsideNo+"</b></li>		<li><span>所属公司：</span>"+e.orderInfo.vendorName+"</li>		<li><span>客户：</span>"+e.orderInfo.companyCode+"-"+e.orderInfo.companyAbbr+'</li>		<li class="currencyName"><span>交易币别：</span>'+e.orderInfo.currencyName+'</li>		<li id="taxName"><span>交易税别：</span><em>'+e.orderInfo.taxName+'</em><label class="checkbox'+(1==e.orderInfo.isContainTax?" on":"")+'"><input type="checkbox" checked="checked" disabled>含税'+100*e.orderInfo.taxRate+"%</label></li>		<li><span>销售日期：</span>"+transDate((new Date).getTime())+'</li>	</ul> <span name="headInfos" class="edit"></span></div>')}}),a},prodAnswerInfo:function(){var e=this,a="";return $.ajax({type:"POST",async:!1,url:config.serviceUrl,data:{param:'{"poAnswerId":'+_vParams.poAnswerId+',"vendorId":'+_vParams.companyId+","+e.tokens+',"serviceId":"B03_findPoAnswerLineList", "commonParam":'+e.commonParam+"}"},success:function(o){if(o=o||{},o.success){var n=o.poLineList;e._lineLists=n,a='<h2 class="m-title">产品明细</h2>';for(var t=0,i=n.length;i>t;t++)a+='<div class="item-wrap" data-index="'+t+'">	<ul>		<li class="prodCode"><span>物料编码：</span><b>'+n[t].vProdCode+'</b></li>		<li class="prodDetail"><span>物料详细：</span><p><em>'+n[t].vProdName+"</em><em>"+n[t].vProdScale+"</em></p></li>		<li><section><span>数量：</span><em>"+n[t].vPurchaseQty+"</em>"+n[t].vAnswerUnitName+"/<em>"+n[t].vValuationQty+"</em>"+n[t].vValuationUnitName+"</section><section><span>交期：</span><em>"+n[t].expectedDelivery+'</em></section></li>		<li class="price"><span>单价：</span>&yen; '+formatMoney(1===e.orderInfo.isContainTax?n[t].vTaxPrice:n[t].vPrice)+"/"+n[t].vValuationUnitName+'</li>		<li class="files"><span>附件：</span></li>		<li class="subtotal"><span>小计：</span><b>&yen; '+formatMoney(n[t].vTaxLineTotal)+'</b></li>	</ul>  <span name="bodyInfos" class="edit"></span></div>';e.load=!0}else fnTip.hideLoading(),container.show().html('<p style="line-height:2rem; text-align:center">'+o.errorMsg+"</p>")}}),a},othersCost:function(){var e=this,a="";if(e.load)return $.ajax({type:"POST",async:!1,url:config.serviceUrl,data:{param:'{"poAnswerId":'+_vParams.poAnswerId+',"vendorId":'+_vParams.companyId+","+e.tokens+',"serviceId":"B03_findPoAnswerOtherCostList", "commonParam":'+e.commonParam+"}"},success:function(o){if(o=o||{},o.success){var n=o.poOthreCostList;e._othersCost=n,a='<h2 class="m-title">其他费用</h2><div class="item-wrap" data-index="0"><ul>';for(var t=0,i=n.length;i>t;t++)a+='<li class="costName" data-costName="'+n[t].costName+'"><span>'+n[t].costName+"：</span><b>&yen; "+formatMoney(n[t].costAmount)+"</b></li>";a+='<li id="othersCostSubtotal" class="subtotal"><span>小计：</span><b>&yen; '+formatMoney(e.orderInfo.vOtherCostTotal)+"</b></li>",a+="</ul>",a+=0==n.length?"":'<span name="otherCostInfos" class="edit editOther"></span>',a+="</div>"}}}),a},reQtys:function(e){var a=0;return e.find(".int02").each(function(){var e=$(this);a+=Number(e.val())}),a},reCostTotalFn:function(){var e=0;return $(".contarin").find(".subtotal").each(function(){e+=Number($(this).attr("data-vtotal"))}),e},start:function(){function e(){var e;a._lineLists.forEach(function(o,n){e="",o.vFileList=[];var t={token:_vParams.token,secretNumber:_vParams.secretNumber,serviceId:"B01_findFileList",companyId:a.orderInfo.companyId,id:o.id,commonParam:commonParam(),docType:"24",fileSource:1,searchType:2};GetAJAXData("POST",t,function(a){if(a.success){for(var t=0;t<a.fileList.length;t++)e+='<a href="'+a.fileList[t].fileUrl+'"><i class=i-'+(_reg.test(a.fileList[t].fileName)?"image":"word")+"></i>"+a.fileList[t].fileName+"</a>";a.fileList.length>0&&prodAnswerCon.find(".files").eq(n).html("<span>附件：</span><p>"+e+"</p>").show(),o.vFileList=a.fileList}},!0)}),$scope.poLineList=a._lineLists}var a=this;orderAnswerCon.html(a.orderBaseInfo());var o={serviceId:"B01_queryAllPlatformCurrency",token:_vParams.token,secretNumber:_vParams.secretNumber,commonParam:commonParam()};GetAJAXData("POST",o,function(e){if(e.success&&!isEmpty(e.platformCurrencyList[0])){$platformCurrencyList=e;for(var o=0,n=e.platformCurrencyList.length;n>o;o++)if(e.platformCurrencyList[o].currencyCode==a.orderInfo.pCurrencyCode)return $currencySymbol=e.platformCurrencyList[o].currencySymbol,!1}}),prodAnswerCon.html(a.prodAnswerInfo()),othersCostCon.html(a.othersCost()),$(".item-total").html("订单总金额：&yen;"+formatMoney(a.orderInfo.vTotalAmount)).show(),e(),$logisticsType.currValue=enumFn(a.logisticsType,a.orderInfo.logisticsType),$logisticsType.logisticsType=a.orderInfo.logisticsType,$currencyData.currencyInfo={id:a.orderInfo.currencyId,currencyCode:a.orderInfo.currencyCode,currencyName:a.orderInfo.currencyName};var n={token:_vParams.token,secretNumber:_vParams.secretNumber,serviceId:"B01_getCompCurrencyByPCurrency",companyId:_vParams.companyId,currencyCodeP:a.orderInfo.pCurrencyCode,commonParam:commonParam()};GetAJAXData("POST",n,function(e){if(e.success&&!isEmpty(e.currencyInfo.currencyName))if($currencyData.currencyInfo=e.currencyInfo,orderAnswerCon.find(".currencyName").html("<span>交易币别：</span>"+e.currencyInfo.currencyName),a.isDisplayRate=!1,(0==e.currencyInfo.isBase||""==e.currencyInfo.currencyName)&&(a.isDisplayRate=!0),1==e.currencyInfo.isBase)a.addval_localCurrencyId=e.currencyInfo.id,a.addval_localCurrencyCode=e.currencyInfo.currencyCode,a.addval_localCurrencyName=e.currencyInfo.currencyName,a.addval_exchangeRate="1";else{var o={token:_vParams.token,secretNumber:_vParams.secretNumber,serviceId:"B01_getExchangeRateByCurrency",companyId:a.orderInfo.vendorId,currencyId:e.currencyInfo.id,commonParam:commonParam(),rateDate:new Date(a.orderInfo.poFormDate).getTime()};GetAJAXData("POST",o,function(e){e.success&&($ExchangeRateData=e,a.addval_localCurrencyId=e.baseCurrencyId,a.addval_localCurrencyCode=e.baseCurrencyCode,a.addval_localCurrencyName=e.baseCurrencyName,a.addval_exchangeRate=e.exchangeRate)},!0)}},!0),$taxData.taxInfo={taxName:a.orderInfo.taxName,taxCode:a.orderInfo.taxCode,taxId:a.orderInfo.taxId,taxRate:a.orderInfo.taxRate,isContainTax:a.orderInfo.isContainTax};var t={token:_vParams.token,secretNumber:_vParams.secretNumber,serviceId:"B01_getTaxByCustomerTax",companyId:a.orderInfo.vendorId,cTaxId:a.orderInfo.taxId,customerId:a.orderInfo.companyId,commonParam:commonParam()};GetAJAXData("POST",t,function(e){e.success&&(isEmpty(e.taxName)||($("#taxName").find("em").html(e.taxName),$taxData.taxInfo=e))},!0);var i={token:_vParams.token,secretNumber:_vParams.secretNumber,serviceId:"B01_findTaxList",companyId:a.orderInfo.vendorId,taxStyle:2,commonParam:commonParam()};GetAJAXData("POST",i,function(e){e.success&&(isEmpty(e.taxList[0])||($taxListData=e))},!0),$conditionJson.conditionName=a.orderInfo.conditionName,$conditionJson.id=a.orderInfo.conditionId,$conditionJson.conditionCode=a.orderInfo.conditionCode;var r={token:_vParams.token,secretNumber:_vParams.secretNumber,serviceId:"B01_findCompanyConditionList",companyId:_vParams.companyId,conditionType:"2"};GetAJAXData("POST",r,function(e){e.success&&(isEmpty(e.conditionList[0])||($conditionData=e))},!0);var s={token:_vParams.token,secretNumber:_vParams.secretNumber,serviceId:"B01_getConditionByCustomerCondition",companyId:a.orderInfo.vendorId,customerId:a.orderInfo.companyId,cConditionId:a.orderInfo.conditionId};GetAJAXData("POST",s,function(e){e.success&&(isEmpty(e.conditionName)||($conditionJson=e))},!0),a.privateDefultAddrName=a.orderInfo.logisticsAddrName,a.privateDefultAddrId="",a.addval_contactPerson=a.orderInfo.contactPerson,a.addval_cityName=a.orderInfo.cityName,a.addval_cityCode=a.orderInfo.cityCode,a.addval_provinceCode=a.orderInfo.provinceCode,a.addval_provinceName=a.orderInfo.provinceName,a.addval_countryName=a.orderInfo.countryName,a.addval_countryCode=a.orderInfo.countryCode,a.addval_districtCode=a.orderInfo.districtCode,a.addval_districtName=a.orderInfo.districtName,a.addval_invId=a.orderInfo.invId,a.addval_invCode=a.orderInfo.invCode,a.addval_invName=a.orderInfo.invName,a.addval_address=a.orderInfo.address,a.addval_mobile=a.orderInfo.mobile,a.addval_isDefault="",a.addval_addressCompName="",a.addval_addressCode="",a.addval_addressType="",a.addval_addressId="",a.addval_zipCode="",a.addval_tel="",a.addval_status="",a.addval_remark="";var d={token:_vParams.token,secretNumber:_vParams.secretNumber,serviceId:"B01_getAddrInfoByCustomerAddrId",companyId:a.orderInfo.vendorId,cAddressId:a.orderInfo.addressId,customerId:a.orderInfo.companyId,type:"2"};GetAJAXData("POST",d,function(e){if(e.success&&($AddrData=e,!isEmpty(e.customerAddress))){var o=e.customerAddress;a.privateDefultAddrName=o.provinceName+o.cityName+o.districtName+o.address+"（收货人："+o.contactPerson+"，电话："+o.mobile+"，商家仓库："+o.invName+"）",a.privateDefultAddrId=o.addressId,a.addval_contactPerson=o.contactPerson,a.addval_cityName=o.cityName,a.addval_cityCode=o.cityCode,a.addval_provinceCode=o.provinceCode,a.addval_provinceName=o.provinceName,a.addval_countryName=o.countryName,a.addval_countryCode=o.countryCode,a.addval_districtCode=o.districtCode,a.addval_districtName=o.districtName,a.addval_invId=o.invId,a.addval_invCode=o.invCode,a.addval_invName=o.invName,a.addval_address=o.address,a.addval_mobile=o.mobile,a.addval_isDefault=o.isDefault,a.addval_addressCompName=o.addressCompName,a.addval_addressCode=o.addressCode,a.addval_addressType=o.addressType,a.addval_addressId=o.addressId,a.addval_zipCode=o.zipCode,a.addval_tel=o.tel,a.addval_status=o.status,a.addval_remark=o.remark}}),$payWayTypeData.payWayName=a.orderInfo.payWayName,$payWayTypeData.payWayId=a.orderInfo.payWayId,$payWayTypeData.payWayCode=a.orderInfo.payWayCode;var c={token:_vParams.token,secretNumber:_vParams.secretNumber,serviceId:"B01_getPayWayByCustomerPayWay",companyId:a.orderInfo.vendorId,customerId:a.orderInfo.companyId,cPayWayId:a.orderInfo.payWayId};GetAJAXData("POST",c,function(e){e.success&&(isEmpty(e.payWapName)||($payWayTypeData=e))},!0);var l={token:_vParams.token,secretNumber:_vParams.secretNumber,serviceId:"B01_findCompanyPayWayList",companyId:a.orderInfo.vendorId,payWayType:"1"};GetAJAXData("POST",l,function(e){e.success&&(isEmpty(e.payWayList[0])||($payWayData=e))},!0);var m={token:_vParams.token,secretNumber:_vParams.secretNumber,serviceId:"B01_findFileList",companyId:a.orderInfo.companyId,id:a.orderInfo.id,commonParam:commonParam(),docType:"24",fileSource:1,searchType:1};GetAJAXData("POST",m,function(e){e.success&&($fileData=e)},!0),a.load&&bottomBar(["share"],a.memberId,"","确定转销售"),container.on("click","span.edit, a.item-link",function(){var e=$(this),o=(e.parents(".item-wrap"),e.attr("name")),n=$body.scrollTop();switch(o){case"headInfos":orderReviseInfoCon.html(a.editHeadInfo(n)),setTimeout(function(){a.taxTypeSelect3()},300);break;case"bodyInfos":var t=e.parent(".item-wrap").attr("data-index");orderReviseInfoCon.html(a.editBodyInfo(t,n)),setTimeout(function(){a.units(t),a.editProdCode()},300);break;case"otherCostInfos":orderReviseInfoCon.html(a.editOthersCost(n));break;case"payInfo":orderReviseInfoCon.html(a.editPayInfo(n)),setTimeout(function(){a.conditionSelect(),a.LogisticalSelect(),a.payWaySelect()},300);break;case"remark":orderReviseInfoCon.html(a.editRemark(n)),$("#intRemarks").val($myRemarkVal)}$body.scrollTop(0),container.addClass("contarinEdit"),$("#jBottom").addClass("m-bottom-hide")}).on("click",".btn-wrap .btnB",function(){var e=$(this);if(e.is("#saveHeadInfo")&&$taxData.taxInfo.taxName!=$("#taxType").select3("value")&&($taxData.taxInfo.taxName=$("#taxType").select3("value"),$taxListData.success,addval_taxInfo=!0),e.is("#saveBodyInfo"),e.is("#saveOthersCost")){var o=$(".hideItemCon").find(".costName"),n=$(".showItemCon").find(".costName");o.forEach(function(e,a){var o=e.value.replace(new RegExp(/(:)/g),"");o=o.replace(new RegExp(/(：)/g),""),n.eq(a).find("span").eq(0).html(o+"："),n.eq(a).attr("data-costname",o)})}e.is("#savePayInfo")&&($conditionJson.conditionName!=$("#dealType").select3("value")&&($conditionJson.conditionName=$("#dealType").select3("value"),$conditionData.success&&$conditionData.conditionList.forEach(function(e){e.conditionName==$conditionJson.conditionName&&($conditionJson.id=e.id,$conditionJson.conditionCode=e.conditionCode)}),addval_conditionInfo=!0),$payWayTypeData.payWayName!=$("#checkoutType").select3("value")&&($payWayTypeData.payWayName=$("#checkoutType").select3("value"),$payWayData.success&&$payWayData.payWayList.forEach(function(e){e.payWayName==$payWayTypeData.payWayName&&($payWayTypeData.payWayId=e.payWayId,$payWayTypeData.payWayCode=e.payWayCode)}),addval_paywayInfo=!0),$logisticsType.currValue!=$("#logisticsType").select3("value")&&($logisticsType.currValue=$("#logisticsType").select3("value"),$logisticsType.logisticsType=reEnumFn(a.logisticsType,$logisticsType.currValue))),e.is("#saveRemark")&&($myRemarkVal=$("#intRemarks").val());var t=e.attr("data-scrollTop");container.removeClass("contarinEdit"),$("#jBottom").removeClass("m-bottom-hide"),setTimeout(function(){$body.scrollTop(t)},200)}),$body.on("click",".bottom-btn-confirm",function(){a.returnSale()})},initSelect3:function(e,a,o){$(e).select3({allowClear:!0,items:a,placeholder:"请选择",showSearchInputInDropdown:!1,value:o})},editHeadInfo:function(e){var a=this,o="";return o+='<div id="reviseBaseInfo" class="m-item"><h2 class="m-title">基本信息</h2><div class="item-wrap">	<ul>		<li><span>客户单号：</span><b>'+a.orderInfo.poInsideNo+"</b></li>		<li><span>客户：</span>"+a.orderInfo.companyAbbr+'</li>		<li><span>交易币种：</span><em id="currencyId">'+$currencyData.currencyInfo.currencyName+'</em></li>		<li><span>交易税种：</span><em id="currTax" class="currTax">'+$taxData.taxInfo.taxName+'</em><label class="checkbox'+(1==a.orderInfo.isContainTax?" on":"")+'"><input type="checkbox" checked="checked" disabled>含税'+100*a.orderInfo.taxRate+'%</label></li>		<li><span>销售日期：</span><em id="poFormDate">'+transDate((new Date).getTime())+'</li>	</ul></div></div><div class="m-item">	<h2 class="m-title">销售订单信息维护</h2>	<div class="item-wrap">		<section class="clearfix">			<span class="c-label">交易币种：</span>			<div id="currency" class="c-cont">				<p class="c-txt">'+$currencyData.currencyInfo.currencyName+'</p>				<div class="curSelect"></div>			</div>		</section>		<section class="m-select clearfix">			<span class="c-label">交易税种：</span>			<div class="c-cont">				<div id="taxType" class="select3-input"></div>				<p><label class="checkbox'+(1==a.orderInfo.isContainTax?" on":"")+'"><input type="checkbox" checked="checked" disabled>含税'+100*a.orderInfo.taxRate+'%</label></p>			</div>		</section>	</div></div><div class="btn-wrap">	<a href="javascript:;" id="saveHeadInfo" class="btnB" data-scrollTop="'+e+'">完成</a></div>'},taxTypeSelect3:function(){var e=this,a=[];if($taxListData.success)for(var o=0,n=$taxListData.taxList.length;n>o;o++)"1"==e.orderInfo.isContainTax?$taxListData.taxList[o].isContainTax==e.orderInfo.isContainTax&&$taxListData.taxList[o].taxRate==e.orderInfo.taxRate&&a.push($taxListData.taxList[o].taxName):$taxListData.taxList[o].isContainTax==e.orderInfo.isContainTax&&a.push($taxListData.taxList[o].taxName);else a.push($taxData.taxInfo.taxName);e.initSelect3("#taxType",a,$taxData.taxInfo.taxName)},editBodyInfo:function(e,a){{var o=this,n="",t=$scope.poLineList[e];t.poSubLineList.length}return n+='<div class="m-item">	<h2 class="m-title">产品明细</h2>	<div class="item-wrap">		<ul>			<li><span>物料编码：</span>'+t.vProdCode+"</li>			<li><span>物料详细：</span><p>"+t.vProdName+" "+t.vProdScale+"</p></li>			<li><section><span>数量：</span>"+t.vPurchaseQty+t.vAnswerUnitName+"/"+t.vValuationQty+t.vValuationUnitName+"</section><section><span>交期：</span>"+t.vExpectedDelivery+'</section></li>			<li><span class="price">单价：</span>&yen; '+formatMoney(1===o.orderInfo.isContainTax?t.vTaxPrice:t.vPrice)+"/"+t.vValuationUnitName+'</li>		</ul>	</div></div><div class="m-item m-item-units">	<h2 class="m-title">销售订单信息维护</h2>	<div class="item-wrap">		<section class="clearfix">			<span class="c-label"><b>我方编码：</b></span>			<div class="wfItem">				<p class="wfItem-int"><input type="text" class="s-int" value="'+t.vProdCode+'" /><i></i></p>				<p>'+t.vProdName+" "+t.vProdScale+'</p>			</div>		</section>		<section class="m-select clearfix">			<span class="c-label"><b>数量：</b></span>			<div class="c-cont">				<div class="c-cont-item">					<span>'+t.purchaseQty+'</span>					<div id="purchaseQty_'+e+'" class="select3-input" data-index="0"></div>				</div>				<div class="c-cont-item">					<span>'+t.valuationQty+'</span>					<div id="valuationQty_'+e+'" class="select3-input" data-index="1"></div>				</div>			</div>		</section></div></div><div class="btn-wrap"><a href="javascript:;" id="saveBodyInfo" class="btnB" data-scrollTop="'+a+'" data-index="'+e+'">完成</a></div>'},units:function(e){var a=this,o=[],n=[];$.ajax({type:"POST",async:!1,url:config.serviceUrl,data:{param:'{"serviceId":"B01_findProdUnitListByProd","companyId":'+_vParams.companyId+',"prodId":"'+a._lineLists[e].prodId+'",'+a.tokens+',"commonParam":'+a.commonParam+"}"},success:function(t){if(t=t||{},t.success)for(var i=t.prodUnitList,r=0,s=i.length;s>r;r++)o.push(i[r].prodUnitName),n.push(i[r].basicUnitName);else o.push(a._lineLists[e].purchaseUnitName),n.push(a._lineLists[e].valuationUnitName)}});for(var t=$(".m-select").length,i=0;t>i;i++)a.initSelect3("#purchaseQty_"+i,o,a._lineLists[e].purchaseUnitName),a.initSelect3("#valuationQty_"+i,n,a._lineLists[e].valuationUnitName);var r=$(".m-item-units").find(".m-select");r.find(".select3-input").change(function(){var e=$(this),a=e.attr("data-index"),o=e.select3("value");e.parents(".m-item-units").find(".select3-input").forEach(function(e){$(e).attr("data-index")==a&&$(e).find(".select3-single-selected-item").attr("data-item-id",o).text(o)})})},editProdCode:function(){function e(e){var a=e.parents(".item-wrap");a.find(".wfItem").show(),a.find(".itemEdit").hide(),a.find(".edit").show(),$("#formTip").remove()}var a=this;container.on("click",".poBodyEdit",function(){var e=$(this),a=e.parent(".item-wrap");e.hide(),a.find(".wfItem").hide(),a.find(".itemEdit").show(),$body.append(formTip)}).on("click",".btn-save",function(){var o=$(this),n=o.parents(".itemEdit").find(".int-search").val();$.ajax({type:"POST",url:config.serviceUrl,data:{param:'{"serviceId": "B01_getProdInfoByCode","companyId":"'+_vParams.companyId+'","prodCode":"'+n+'","commonParam":'+a.commonParam+","+a.tokens+"}"},success:function(a){if(a=a||{},a.success){var t=a.prodInfo;if(void 0==t)return $("#formTip").html("产品编码错误，请重新输入").addClass("formTipShow"),!1;n==t.prodCode&&(o.parents(".item-wrap").find(".wfItem").html(t.prodCode+"<p>"+t.prodName+" "+t.prodScale+"</p>"),e(o))}}})}).on("click",".btn-cancel",function(){var a=$(this);e(a)})},editOthersCost:function(e){for(var a=this,o=a._othersCost,n=o.length,t=$(".showItemCon").find(".costName"),i='<div class="m-item"><h2 class="m-title">其他费用</h2><div class="item-wrap"><ul>',r=0;n>r;r++)i+="<li><span>"+t.eq(r).attr("data-costName")+"：</span><b>&yen; "+formatMoney(o[r].vCostAmount)+"</b></li>";i+="</ul></div></div>",i+='<div class="m-item"><h2 class="m-title">订单其他费用维护</h2><div class="item-wrap">';for(var s=0;n>s;s++)i+='<section class="m-select clearfix">	<div class="c-cont c-cont2">		<input type="text" class="costName" value="'+t.eq(s).attr("data-costName")+'">		<p class="fy">&yen;'+formatMoney(o[s].vCostAmount)+"</p>	</div></section>";return i+='</div></div><div class="btn-wrap"><a href="javascript:;" id="saveOthersCost" class="btnB" data-scrollTop="'+e+'">完成</a></div>'},editPayInfo:function(e){var a=this,o=a.orderInfo;return html='<div id="payInfoList" class="m-item">	<div class="item-wrap">		<ul>			<li><span>交易条件：</span><p id="jyCurrVal">'+$conditionJson.conditionName+'</p></li>			<li><span>物流方式：</span><p><em id="logisticsVal">'+$logisticsType.currValue+"</em></p></li>			<li><span>"+(3==$logisticsType.logisticsType?"自提点":"收货地址")+"：</span><p>"+o.provinceName+o.cityName+o.districtName+o.address+"<br>收货人："+o.contactPerson+"，电话："+o.mobile+'</p></li>			<li><span>收款条件：</span><p id="payWayName">'+$payWayTypeData.payWayName+"</p></li>			<li><span>发票类型：</span><p>"+enumFn(a.invoiceType,o.invoiceType)+"</p></li>			<li><span>发票抬头：</span><p>"+o.invoiceHeader+"</p></li>			<li><span>发票类容：</span><p>"+o.invoiceContent+'</p></li>		</ul>	</div></div><div id="rePayInfoList" class="m-item">	<div class="item-wrap">		<section class="m-select clearfix">			<span class="c-label">交易条件：</span>			<div class="c-cont">				<div id="dealType" class="select3-input"></div>			</div>		</section>		<section class="m-select clearfix">			<span class="c-label">物流方式：</span>			<div class="c-cont">				<div id="logisticsType" class="select3-input"></div>			</div>		</section>		<section id="address" class="clearfix">			<span class="c-label">'+(3==$logisticsType.logisticsType?"自提点":"收货地址")+'：</span>			<div class="c-cont">				<p class="c-txt">'+o.provinceName+o.cityName+o.districtName+o.address+"<br>收货人："+o.contactPerson+"，电话："+o.mobile+'</p>			</div>		</section>		<section class="m-select clearfix">			<span class="c-label">收款条件：</span>			<div class="c-cont">				<div id="checkoutType" class="select3-input"></div>			</div>		</section>		<section class="clearfix">			<span class="c-label">发票类型：</span>			<div class="c-cont">				<p class="c-txt">'+enumFn(a.invoiceType,o.invoiceType)+'</p>			</div>		</section>		<section class="clearfix">			<span class="c-label">开票抬头：</span>			<div class="c-cont">				<p class="c-txt">'+o.invoiceHeader+'</p>			</div>		</section>		<section class="clearfix">			<span class="c-label">发票内容：</span>			<div class="c-cont">				<p class="c-txt">'+o.invoiceContent+'</p>			</div>		</section>	</div></div><div class="btn-wrap"><a href="javascript:;" id="savePayInfo" class="btnB" data-scrollTop="'+e+'">完成</a></div>'},conditionSelect:function(){var e=this,a=[];if($conditionData.success){if(0==$conditionData.conditionList.length)return a.push($conditionJson.conditionName),e.initSelect3("#dealType",a,$conditionJson.conditionName),!1;for(var o=$conditionData.conditionList.length,n=0;o>n;n++)a.push($conditionData.conditionList[n].conditionName);e.initSelect3("#dealType",a,$conditionJson.conditionName)}else a.push($conditionJson.conditionName),e.initSelect3("#dealType",a,$conditionJson.conditionName)},LogisticalSelect:function(){var e=this,a=[];e.logisticsType.forEach(function(e){a.push(e.Value)}),e.initSelect3("#logisticsType",a,$logisticsType.currValue)},payWaySelect:function(){var e=this,a=[];if(!$payWayData.success)return a.push(e.orderInfo.payWayName),e.initSelect3("#checkoutType",a,e.orderInfo.payWayName),!1;for(var o=$payWayData.payWayList,n=o.length,t=0;n>t;t++)a.push(o[t].payWayName);e.initSelect3("#checkoutType",a,$payWayTypeData.payWayName)},editRemark:function(e){var a=this,o='<div class="remarks-wrap"><div id="provisions" class="item-wrap clause">	<h2>补充条款：</h2>	<p>'+a.orderInfo.agreement+'</p></div><div id="taRemarks" class="item-wrap taRemarks">	<h2>备注信息：</h2>	<p>'+a.orderInfo.remark+'</p></div><div id="files" class="item-wrap attachment">	<h2>订单附件：</h2>';0==$fileData.fileList.length&&(o+="<p><b>0个附件</b></p>");for(var n=0;n<$fileData.fileList.length;n++)o+='<p><a href="'+$fileData.fileList[n].fileUrl+'"><i class=i-'+(_reg.test($fileData.fileList[n].fileName)?"image":"word")+"></i>"+$fileData.fileList[n].fileName+"</a></p>";return o+='</div><div id="remarks" class="item-wrap int-remarks">	<textarea name="" id="intRemarks" placeholder="填写备注信息"></textarea></div></div></div><div class="btn-wrap"><a href="javascript:;" id="saveRemark" class="btnB" data-scrollTop="'+e+'">完成</a></div>'},popup:function(e,a,o,n,t){new Popup({type:e,title:a,content:o,ok:"确定",cancel:"取消",closeCallBack:n,okCallBack:t})},returnSale:function(){var e=this,a=$taxData.taxInfo.taxName,o=$taxData.taxInfo.taxCode,n=$taxData.taxInfo.taxId,t=$taxData.taxInfo.taxRate,i=$taxData.taxInfo.isContainTax,r=privateDefultUser.employeeCode,s=privateDefultUser.employeeId,d=privateDefultUser.employeeName,c=privateDefultUser.memberId;if(addval_conditionInfo)var l=$conditionJson.conditionName,m=$conditionJson.id,p=$conditionJson.conditionCode;else var l=$conditionJson.conditionName,m="",p="";var v=$payWayTypeData.payWayName,u=$payWayTypeData.payWayId,f=$payWayTypeData.payWayCode,y=e.orderInfo.logisticsName,I=e.orderInfo.logisticsCode,N=[];$fileData.fileList.forEach(function(e){var a={};a.lineNo=e.lineNo,a.fileSource=e.fileSource,a.fileUrl=e.fileUrl,a.fileName=e.fileName,a.fileSize=e.fileSize,a.fileKey=e.fileKey,a.remark=e.remark,N.push(a)});var C={vOtherCostTotal:e.orderInfo.vOtherCostTotal,vTotalAmount:e.orderInfo.vTotalAmount,vTaxTotal:e.orderInfo.vTaxTotal,vTotal:e.orderInfo.vTotal},h={vendorId:e.orderInfo.vendorId.toString(),vendorName:e.orderInfo.vendorName,vendorCode:e.orderInfo.vendorCode,vendorAbbr:e.orderInfo.vendorAbbr,poAnswerId:_vParams.poAnswerId,poId:e.orderInfo.id,poFormNo:e.orderInfo.poFormNo,poInsideNo:e.orderInfo.poInsideNo,currencyId:$currencyData.currencyInfo.id,currencyCode:$currencyData.currencyInfo.currencyCode,currencyName:$currencyData.currencyInfo.currencyName,localCurrencyCode:e.addval_localCurrencyCode,localCurrencyId:e.addval_localCurrencyId,localCurrencyName:e.addval_localCurrencyName,pCurrencyCode:e.orderInfo.pCurrencyCode,pCurrencyName:e.orderInfo.pCurrencyName,exchangeRate:e.addval_exchangeRate,taxId:n,taxName:a,taxCode:o,isContainTax:i,taxRate:t,provinceCode:e.orderInfo.provinceCode,provinceName:e.orderInfo.provinceName,customerCode:e.orderInfo.companyCode,customerId:e.orderInfo.companyId,customerAbbr:e.orderInfo.companyAbbr,customerName:e.orderInfo.companyName,soFormDate:(new Date).getTime(),soInsideNo:"",soManCode:r,soManId:s,soManName:d,soManPid:c},x={logisticsCode:I,logisticsName:y,logisticsType:$logisticsType.logisticsType,contactPerson:e.addval_contactPerson,cityName:e.addval_cityName,cityCode:e.addval_cityCode,provinceCode:e.addval_provinceCode,provinceName:e.addval_provinceName,countryName:e.addval_countryName,countryCode:e.addval_countryCode,districtCode:e.addval_districtCode,districtName:e.addval_districtName,invId:e.addval_invId,invCode:e.addval_invCode,invName:e.addval_invName,addressId:e.addval_addressId,address:e.addval_address,mobile:e.addval_mobile,payWayId:u,payWayName:v,payWayCode:f,conditionCode:p,conditionName:l,conditionId:m,invoice:e.orderInfo.invoice,invoiceType:e.orderInfo.invoiceType,invoiceContent:e.orderInfo.invoiceContent,invoiceHeader:e.orderInfo.invoiceHeader,invoiceName:e.orderInfo.invoiceName,invoiceAccount:e.orderInfo.invoiceAccount,invoiceTel:e.orderInfo.invoiceTel,invoiceBank:e.orderInfo.invoiceBank,invoiceAddress:e.orderInfo.invoiceAddress,invoicePayMark:e.orderInfo.invoicePayMark},T={agreement:e.orderInfo.agreement,vRemark:$myRemarkVal,remark:e.orderInfo.remark},_=e._othersCost,P=[];if($scope.poLineList.forEach(function(e){if(isEmpty(e.purchaseUnitInfo))var a="",o="",n=e.purchaseUnitName;else var a=e.purchaseUnitInfo.prodUnitCode,o=e.purchaseUnitInfo.id,n=e.purchaseUnitInfo.prodUnitName;if(isEmpty(e.valuationUnitInfo))var t="",i="",r=e.valuationUnitName;else var t=e.valuationUnitInfo.prodUnitCode,i=e.valuationUnitInfo.id,r=e.valuationUnitInfo.prodUnitName;e.purchaseUnitId==e.valuationUnitId&&(i=o,t=a,r=n);var s={fileList:[],expectedDelivery:new Date(e.expectedDelivery).getTime(),vProdId:e.vProdId,vProdName:e.vProdName,vProdDesc:e.vProdDesc,vProdCode:e.vProdCode,vProdScale:e.vProdScale,vFileCount:e.vFileList.length,vRemark:e.vRemark,cProdId:e.prodId,cProdName:e.prodName,cProdCode:e.prodCode,cProdScale:e.prodScale,cProdDesc:e.prodDesc,fileCount:e.fileCount,remark:e.remark,invName:e.invName,invCode:e.invCode,invId:e.invId,taxPrice:e.taxPrice,taxLineTotal:e.taxLineTotal,salesQty:e.purchaseQty,salesUnitId:o,salesUnitCode:a,salesUnitName:n,valuationQty:e.valuationQty,valuationUnitId:i,valuationUnitCode:t,valuationUnitName:r,poLineId:e.id,poLineNo:e.lineNo,lineNo:e.lineNo,price:e.price,lineAmount:e.lineAmount,locationId:e.localtionId,locationCode:e.localtionCode,locationName:e.localtionName,deliveryValuationQty:0,deliveryQty:0,receiveValuationQty:0,receiveQty:0,returnQty:0,returnValuationQty:0,exchangeQty:0,exchangeValuationQty:0};e.vFileList.forEach(function(e){var a={};a.lineNo=e.lineNo,a.fileSource=e.fileSource,a.fileUrl=e.fileUrl,a.fileName=e.fileName,a.fileSize=e.fileSize,a.fileKey=e.fileKey,a.remark=e.remark,s.fileList.push(a)}),P.push(s)}),""==h.vendorId)return void e.popup("alert","","操作失败：企业ID 为空！");if(""==h.currencyName)return void e.popup("alert","","操作失败：交易币种名称 为空！");if(""==h.localCurrencyCode)return void e.popup("alert","","操作失败：企业本币编码 为空！");if(""==h.localCurrencyId)return void e.popup("alert","","操作失败：企业本币ID 为空！");if(""==h.localCurrencyName)return void e.popup("alert","","操作失败：企业本币名称 为空！");if(""==h.pCurrencyCode)return void e.popup("alert","","操作失败：平台币种编码 为空！");if(""==h.pCurrencyName)return void e.popup("alert","","操作失败：平台币种名称 为空！");if(0!=h.isContainTax&&1!=h.isContainTax)return void e.popup("alert","","操作失败：是否含税 不正确！");if(1!=x.invoice&&""==x.invoiceType)return void e.popup("alert","","操作失败：发票类型 为空！");if(1!=x.invoice&&1==x.invoiceType&&(""==x.invoiceHeader||""==x.invoiceContent))return void e.popup("alert","","操作失败：发票抬头或发票内容 为空！");if(1!=x.invoice&&1!=x.invoiceType&&""==x.invoiceAccount)return void e.popup("alert","","操作失败：发票账号 为空！");if(""==x.logisticsType)return void e.popup("alert","","操作失败：物流方式 为空！");if(3!=x.logisticsType&&""==x.logisticsName)return void e.popup("alert","","操作失败：物流商 为空！");if(""==x.conditionName)return void e.popup("alert","","操作失败：交易条件名称 为空！");if(void 0!=h.exchangeRate&&isNaN(1*h.exchangeRate))return void e.popup("alert","","操作失败：汇率应为整数或小数！");var b={saleOrderFile:N,orderTotalAmount:C,baseInfo:h,prodDetailList:P,payInfo:x,appendContact:T,otherCostList:_,serviceId:"B03_poAnswerToSalesOrder",commonParam:commonParam(),token:_vParams.token,secretNumber:_vParams.secretNumber};console.log(JSON.stringify(b)),$.ajax({type:"POST",url:config.serviceUrl,data:{param:JSON.stringify(b)},success:function(a){a=a||{},a.success?($scope.pageState="success",$scope.success_soFormNo=a.soFormNo,$scope.success_soFormId=a.id,fnTip.success(2e3),setTimeout(function(){window.location.href=config.htmlUrl+'salesDetail.html?param={"id":'+$scope.success_soFormId+',"companyId":"'+e.orderInfo.vendorId+'","secretNumber":"'+_vParams.secretNumber+'","token":"'+_vParams.token+'"}'
},2e3)):e.popup("alert","","操作失败："+a.errorMsg)}})}};