var formTip='<div id="formTip" class="formTip"></div>',$itemTips=$(".item-tips"),container=$(".contarin"),orderReviseInfoCon=$("#orderReviseInfoCon"),orderAnswerCon=$("#orderAnswerInfo"),prodAnswerCon=$("#prodAnswerInfo"),othersCostCon=$("#othersCost"),$scope={},$platformCurrencyList,$currencySymbol="",$priceDecimalNum="",$amountDecimalNum="",$fileData,$btnTxet="分批答交",_vParams=JSON.parse(decodeURI(getQueryString("param"))),_reg=/^(\s|\S)+(jpg|jpeg|png|gif|bmp|JPG|JPEG|PNG|GIF|BMP)+$/,Lists=function(){this.init()};Lists.prototype={init:function(){var e=this;e._files=[],e._othersCost=[],e.status,e.vStatus,e.totals=0,e.load=!1,e.memberId="",setTimeout(function(){container.show(),fnTip.hideLoading()},0),requestFn("B02_LogisticsType",function(a){"0"==a.errorCode&&(e.logisticsType=a.dataSet.data.detail)}),requestFn("B02_InvoiceType",function(a){"0"==a.errorCode&&(e.invoiceType=a.dataSet.data.detail)}),requestFn("B02_Invoice",function(a){"0"==a.errorCode&&(e.invoiceInfoName=a.dataSet.data.detail)}),e.start(),container.on("click","span.edit",function(){if($(".responseBox").length)return popup("alert","",'请先"取消/确定"未完成操作再继续！'),!1;var a=$(this),t=a.parent(".item-wrap"),n=t.attr("data-index");return a.is(".editOther")?(e.editResponseCost(t,n),e.addNewCost(),!1):void e.editResponse(t,n)}),e.dateFn(),e.hideTip(),e.delResponse()},orderBaseInfo:function(){var e=this,a="",t={serviceId:"B03_getPurchaseOrderAnswerInfo",poAnswerId:_vParams.poAnswerId,vendorId:_vParams.vendorId,commonParam:commonParam(),token:_vParams.token,secretNumber:_vParams.secretNumber};return $.ajax({type:"POST",async:!1,url:config.serviceUrl,data:"param="+JSON.stringify(t),success:function(t){t=t||{},t.success&&(e.orderInfo=t.poAnswerOrderInfo,e.memberId=e.orderInfo.poManId,e.status=e.orderInfo.status,e.vStatus=e.orderInfo.vStatus,$currencySymbol=e.orderInfo.currencySymbol,$priceDecimalNum=e.orderInfo.priceDecimalNum,$amountDecimalNum=e.orderInfo.amountDecimalNum,a+='<h2 class="m-title">基础信息</h2><div class="item-wrap">	<ul>		<li><span>平台单号：</span><b>'+e.orderInfo.poFormNo+"</b></li>		<li><span>内部单号：</span><b>"+e.orderInfo.poInsideNo+"</b></li>		<li><span>客户：</span><b>"+e.orderInfo.companyCode+"-"+e.orderInfo.companyAbbr+"</b></li>		<li><span>交易币别：</span>"+e.orderInfo.currencyName+"</li>		<li><span>交易税别：</span>"+e.orderInfo.taxName+'<label class="checkbox'+(1==e.orderInfo.isContainTax?" on":"")+'"><input type="checkbox" checked="checked" disabled>含税'+100*e.orderInfo.taxRate+"%</label></li>		<li><span>交易条件：</span>"+e.orderInfo.conditionName+"</li>		<li><span>付款条件：</span>"+e.orderInfo.payWayName+"</li>		<li><span>采购日期：</span>"+e.orderInfo.poFormDate+"</li>	</ul></div>")}}),a},prodAnswerInfo:function(){var e=this,a="",t={serviceId:"B03_findPoAnswerLineList",poAnswerId:_vParams.poAnswerId,vendorId:_vParams.vendorId,commonParam:commonParam(),token:_vParams.token,secretNumber:_vParams.secretNumber};return $.ajax({type:"POST",async:!1,url:config.serviceUrl,data:"param="+JSON.stringify(t),success:function(t){t=t||{},t.success?($scope.poLineList=t.poLineList,a='<h2 class="m-title">产品信息</h2>',$scope.poLineList.forEach(function(t,n){if(t.vProdName)t.vPurchaseQty||(t.valuationQty=t.valuationQty||t.purchaseQty,t.vPurchaseQty=t.purchaseQty,t.vValuationQty=t.valuationQty,t.vExpectedDelivery=t.expectedDelivery,t.vAnswerUnitName=t.purchaseUnitName,t.vAnswerUnitId=t.purchaseUnitId,t.vAnswerUnitCode=t.purchaseUnitCode,t.vValuationUnitId=t.valuationUnitId,t.vValuationUnitCode=t.valuationUnitCode,t.vValuationUnitName=t.valuationUnitName,t.vPrice=t.price,t.vTaxPrice=t.taxPrice,t.vLineAmount=t.lineAmount,t.vTaxLineTotal=t.taxLineTotal);else{t.valuationQty=t.valuationQty||t.purchaseQty,t.vPurchaseQty=t.purchaseQty,t.vValuationQty=t.valuationQty,t.vExpectedDelivery=t.expectedDelivery,t.vAnswerUnitName=t.purchaseUnitName,t.vAnswerUnitId=t.purchaseUnitId,t.vAnswerUnitCode=t.purchaseUnitCode,t.vValuationUnitId=t.valuationUnitId,t.vValuationUnitCode=t.valuationUnitCode,t.vValuationUnitName=t.valuationUnitName,t.vPrice=t.price,t.vTaxPrice=t.taxPrice,t.vLineAmount=t.lineAmount,t.vTaxLineTotal=t.taxLineTotal;var o={serviceId:"B01_getProdByCustomerProd",token:_vParams.token,secretNumber:_vParams.secretNumber,vendorId:_vParams.vendorId,cProdCode:t.prodCode,commonParam:commonParam(),customerId:e.orderInfo.companyId};GetAJAXData("POST",o,function(e){e.prodMap?(t.vProdId=e.prodMap.prodId,t.vProdCode=e.prodMap.prodCode,t.vProdName=e.prodMap.prodName,t.vProdScale=e.prodMap.prodScale,t.vProdDesc=e.prodMap.prodDesc):(t.vProdName=t.prodName,t.vProdScale=t.prodScale,t.vProdDesc=t.prodDesc)})}1==e.orderInfo.isContainTax?(t._vPrice=t.vTaxPrice/(1+parseFloat(e.orderInfo.taxRate)),t._vTaxPrice=t.vTaxPrice):(t._vPrice=t.vPrice,t._vTaxPrice=t.vPrice*(1+parseFloat(e.orderInfo.taxRate))),t.unitName=!0,t.purchaseUnitName==t.valuationUnitName&&(t.unitName=!1),a+='<div class="item-wrap" data-index="'+n+'">	<ul>		<li class="prodCode" data-prodCode="'+t.prodCode+'" data-prodId="'+t.prodId+'"><span>物料编码：</span><b>'+t.prodCode+"</b></li>		<li><span>物料详细：</span><p>"+t.prodName+" "+t.prodScale+"</p></li>",t.unitName?(a+=(4!=e.vStatus?"<li><section><span>客户数量：</span><em>"+t.purchaseQty+"</em>"+t.purchaseUnitName+"/<em>"+t.valuationQty+"</em>"+t.valuationUnitName+"</section><section><span>交期：</span><em>"+t.expectedDelivery+"</em></section></li>":"")+(1==e.vStatus?"":0==t.poSubLineList.length?'<li class="bfline"><section><span>本方数量：</span><em class="vPurchaseQty">'+t.vPurchaseQty+"</em>"+t.vAnswerUnitName+'/<em class="vValuationQty">'+t.vValuationQty+"</em>"+t.vValuationUnitName+'</section><section><span>交期：</span><em class="vExpectedDelivery">'+t.vExpectedDelivery+"</em></section></li>":""),t.poSubLineList.forEach(function(e,n){a+='<li class="response responseBatch"><section><span'+(0==n?' class="nth0"':"")+'>分批答交：</span><em class="purchaseQty">'+e.purchaseQty+"</em>"+t.purchaseUnitName+'/<em class="valuationQty">'+e.valuationQty+"</em>"+t.valuationUnitName+"</section><section><span"+(0==n?' class="nth0"':"")+'>交期：</span><em class="expectedDelivery">'+e.expectedDelivery+"</em></section></li>"})):(a+=(4!=e.vStatus?"<li><section><span>客户数量：</span><em>"+t.purchaseQty+"</em>"+t.purchaseUnitName+'<em class="hidden">'+t.valuationQty+"</em></section><section><span>交期：</span><em>"+t.expectedDelivery+"</em></section></li>":"")+(1==e.vStatus?"":0==t.poSubLineList.length?'<li class="bfline"><section><span>本方数量：</span><em class="vPurchaseQty">'+t.vPurchaseQty+"</em>"+t.vAnswerUnitName+'<em class="hidden vValuationQty">'+t.vValuationQty+'</em></section><section><span>交期：</span><em class="vExpectedDelivery">'+t.vExpectedDelivery+"</em></section></li>":""),t.poSubLineList.forEach(function(e,n){a+='<li class="response responseBatch"><section><span'+(0==n?' class="nth0"':"")+'>分批答交：</span><em class="purchaseQty">'+e.purchaseQty+"</em>"+t.purchaseUnitName+'<em class="hidden valuationQty">'+e.valuationQty+"</em></section><section><span"+(0==n?' class="nth0"':"")+'>交期：</span><em class="expectedDelivery">'+e.expectedDelivery+"</em></section></li>"})),a+='		<li class="price" data-taxPrice="'+t.taxPrice+'" data-price="'+t.price+'"><span>单价：</span>'+$currencySymbol+(1===e.orderInfo.isContainTax?formatMoney(t.taxPrice,$priceDecimalNum):formatMoney(t.price,$priceDecimalNum))+"/"+t.valuationUnitName+"</li>		<li><span>备注：</span><p>"+t.remark+'</p></li>		<li class="files"><span>附件：</span></li>		<li class="subtotal" data-total="'+t.taxLineTotal+'" data-vTotal="'+(""!=t.vTaxLineTotal||0!=t.vTaxLineTotal?t.vTaxLineTotal:t.taxLineTotal)+'"><span>含税小计：</span><b>'+$currencySymbol+formatMoney(t.taxLineTotal,$amountDecimalNum)+"</b></li>"+(1!=e.vStatus&&4!=e.vStatus?'<li class="response responseTotal" data-vLineAmount="'+t.vLineAmount+'" data-vTaxLineTotal="'+t.vTaxLineTotal+'"><span>答交金额：</span>'+$currencySymbol+formatMoney(""==t.vTaxLineTotal?t.taxLineTotal:t.vTaxLineTotal,$amountDecimalNum)+"</li>":"")+"	</ul>"+(2==e.vStatus?'<span class="edit"></span>':"")+"</div>",e.countQtyRate(t),e.totals+=parseFloat(t.taxLineTotal)}),e.load=!0):(fnTip.hideLoading(),container.show().html('<p style="line-height:2rem; text-align:center">'+t.errorMsg+"</p>"))}}),a},editResponse:function(e,a){function t(){var e="";if(0!=s)for(var t=0;s>t;t++){var n=i.eq(t).find("em");e+='<li class="myResponse"><span'+(0==t?' class="nth0"':"")+'>分批：</span><input type="text" class="int01" name="int01" value="'+n.eq(0).html()+'"><input type="text" class="'+(o[a].unitName?"":"hidden ")+'int02" name="int02" value="'+n.eq(1).html()+'" disabled><div class="timeBox">'+n.eq(2).html()+'</div><input type="hidden" value="'+n.eq(2).html()+'"><i class="btn-del"></i></li>'}return e}var n=this,o=$scope.poLineList,i=e.find(".responseBatch"),s=i.length;s>0&&($btnTxet="新增");var r='<div class="responseBox'+(s>0?" batchBox":"")+'" data-index="'+a+'"><ul class="responseBox1">	<li>		<span>对方：</span>		<p>物料编码：'+o[a].prodCode+"<br>"+o[a].prodName+" "+o[a].prodScale+'</p>	</li>	<li class="myProductInfo">		<span>本方：</span>		<p>物料编码：'+o[a].vProdCode+"<br>"+o[a].vProdName+" "+o[a].vProdScale+"</p>	</li>";r+=o[a].unitName?"	<li><span>数量：</span><em>"+o[a].purchaseQty+o[a].purchaseUnitName+" /</em><em>"+o[a].valuationQty+o[a].valuationUnitName+'</em><span>交期：</span><em class="em03">'+o[a].expectedDelivery+'</em></li>	<li class="bfline"><span>本方：</span><input type="text" class="int01_all" value="'+o[a].vPurchaseQty+'"'+(s>0?" disabled":"")+'><input type="text" class="int02_all" value="'+o[a].vValuationQty+'" disabled><div class="timeBox">'+o[a].vExpectedDelivery+'</div><input type="hidden" value="'+o[a].vExpectedDelivery+'"></li>':"	<li><span>数量：</span><em>"+o[a].purchaseQty+o[a].purchaseUnitName+'</em><em class="hidden">'+o[a].valuationQty+o[a].valuationUnitName+'</em><span>交期：</span><em class="em03">'+o[a].expectedDelivery+'</em></li>	<li class="bfline"><span>本方：</span><input type="text" class="int01_all" value="'+o[a].vPurchaseQty+'"'+(s>0?" disabled":"")+'><input type="text" class="hidden int02_all" value="'+o[a].vValuationQty+'" disabled><div class="timeBox">'+o[a].vExpectedDelivery+'</div><input type="hidden" value="'+o[a].vExpectedDelivery+'"></li>',r+=t()+'</ul><div class="btnBox"><a href="javascript:;" class="addResponse">'+$btnTxet+'</a></div><ul class="responseBox2">	<li><span>单价：</span>¥'+(1===n.orderInfo.isContainTax?formatMoney(o[a].taxPrice,$priceDecimalNum):formatMoney(o[a].price,$priceDecimalNum))+"/"+o[a].valuationUnitName+"</li>	<li><span>备注：</span><p>"+o[a].remark+'</p></li>	<li class="subtotal"><span>小记：</span><b>'+$currencySymbol+formatMoney(o[a].taxLineTotal,$amountDecimalNum)+'</b></li></ul><div class="btns">	<a class="btn-cancel" href="javascript:;">取消</a>	<a class="btn-save" href="javascript:;">确定</a></div></div>',e.hide(),e.after(r),$body.append(formTip),$body.on("input","input.int01_all",function(){var e=$(this),a=e.parents(".responseBox").attr("data-index"),t=isNaN(e.val())?0:e.val();e.val(t),e.next(".int02_all").val($scope.poLineList[a].countQtyRate*t)}),$body.on("input","input.int01",function(){var e=$(this),a=e.parents(".responseBox").attr("data-index"),t=isNaN(e.val())?0:e.val(),o=e.parents(".responseBox").find(".int01_all");n.reQtysAll($(this)),e.val(t),e.next(".int02").val($scope.poLineList[a].countQtyRate*t),o.trigger("input")}),$(".addResponse").eq(0).on("click",function(){function e(){a=0,t=0,s.find(".int01").forEach(function(e){a+=parseFloat(e.value||0)}),s.find(".int02").forEach(function(e){t+=parseFloat(e.value||0)})}var a,t,n=$(this),i=n.parents(".responseBox"),s=i.find(".responseBox1"),r=s.find("li.myResponse").find("input"),l=i.attr("data-index"),c="",d="",p=$scope.poLineList[l].expectedDelivery,m=!0;r.length>1&&r.forEach(function(e){return""==e.value?($("#formTip").html("此分批答交完成后才能继续新增分批！").addClass("formTipShow"),void(m=!1)):void 0}),e(),c=parseFloat(o[l].purchaseQty)-a,d=parseFloat(o[l].valuationQty)-t,c=0>=c?"":c,d=0>=d?"":d;var v='<li class="myResponse"><span>分批：</span><input type="text" class="int01" name="int01" value="'+c+'" /><input type="text" class="'+(o[l].unitName?"":"hidden ")+'int02" name="int02" value="'+d+'" disabled /><div class="timeBox">'+p+'</div><input type="hidden" value="'+p+'" /><i class="btn-del"></i></li>';m&&(s.append(v),e(),s.find(".int01_all").val(a),s.find(".int02_all").val(t),i.addClass("batchBox"),i.find(".int01_all").prop("disabled",!0),n.html("新增"))}),$(".btn-cancel").eq(0).on("click",function(e){n.cancel($(this),prodAnswerCon),e.preventDefault()}),$(".btn-save").eq(0).on("click",function(e){e.preventDefault(),n.modiResponse($(this),a),n.save($(this),prodAnswerCon)})},itemshow:function(e,a){var t=e.parents(".responseBox").attr("data-index");e.parents(".responseBox").remove(),a.find(".item-wrap").eq(t).show(),$("#formTip").remove()},othersCost:function(){var e=this,a="",t=0,n=0,o=!1;if(e.load){var i={token:_vParams.token,secretNumber:_vParams.secretNumber,serviceId:"B03_findPoAnswerOtherCostList",poAnswerId:_vParams.poAnswerId,vendorId:_vParams.vendorId,commonParam:commonParam()};return $.ajax({type:"POST",async:!1,url:config.serviceUrl,data:"param="+JSON.stringify(i),success:function(i){if(i=i||{},i.success){var s=i.poOthreCostList;e._othersCost=s,a='<h2 class="m-title">其他费用</h2><div class="item-wrap" data-index="0"><ul>';for(var r=0,l=s.length;l>r;r++)a+='<li class="mobiCostItem costItem" data-costName="'+s[r].costName+'" data-costAmount="'+s[r].costAmount+'" data-vCostAmount="'+s[r].vCostAmount+'"><span>'+s[r].costName+"：</span><b>"+$currencySymbol+formatMoney(s[r].costAmount,$amountDecimalNum)+"</b>"+(1==e.vStatus||4==e.vStatus?"":'<b class="dj"><em class="money" data-money="'+(""==s[r].vCostAmount?s[r].costAmount:s[r].vCostAmount)+'">'+(""==s[r].vCostAmount?formatMoney(s[r].costAmount,$amountDecimalNum):formatMoney(s[r].vCostAmount,$amountDecimalNum))+"</em></b>")+"</li>",t+=parseFloat(""==s[r].costAmount?0:s[r].costAmount),n+=parseFloat(""==s[r].vCostAmount?s[r].costAmount:s[r].vCostAmount),""!=s[r].vCostAmount&&(o=!0);a+=4!=e.vStatus?'<li id="othersCostSubtotal" class="subtotal" data-total="'+t+'" data-vTotal="'+(o?n:t)+'"><span>客户小计：</span><b>'+$currencySymbol+formatMoney(t,$amountDecimalNum)+"</b></li>":"",1!=e.vStatus&&(a+='<li id="changeCost" class="response" data-otherMoney="'+n+'"><span>本方小计：</span>'+$currencySymbol+formatMoney(n,$amountDecimalNum)+"</li>"),a+="</ul>",a+=2==e.vStatus?'<span class="edit editOther"></span>':"",a+="</div>",e.totals+=parseFloat(t)}}}),a}},editResponseCost:function(e){function a(){var a=$(e).find(".response").not("#changeCost"),t=a.length,n="";if(0!=t)for(var o=0;t>o;o++)n+='<li class="addNewCost"><input type="text" value="'+a.eq(o).attr("data-costname")+'"><input type="text" value="'+a.eq(o).attr("data-vcostamount")+'"><i class="btn-del"></i></li>';return n}for(var t=this,n=t._othersCost,o=n.length,i='<div class="responseBox" data-index="0"><ul class="responseCost">',s=0;o>s;s++){var r=""==$("#othersCost .dj").eq(s).find("em").html()?"":$("#othersCost .dj").eq(s).find("em").attr("data-money");i+="<li><span>"+n[s].costName+"：</span><b>"+$currencySymbol+formatMoney(n[s].costAmount)+'</b><input type="text" class="original" id="dj_'+s+'" value="'+r+'" /></li>'}i+=a(),i+='</ul><div class="btnBox"><a href="javascript:;" class="addCost">新增费用</a></div><div class="btns">	<a class="btn-cancel" href="javascript:;">取消</a>	<a class="btn-save" href="javascript:;">确定</a></div></div>',e.hide(),e.after(i),$body.append(formTip),$(".btn-cancel").eq(0).on("click",function(e){t.cancel($(this),othersCostCon),e.preventDefault()}),$(".btn-save").eq(0).on("click",function(e){t.save($(this),othersCostCon),e.preventDefault()})},addNewCost:function(){var e=!0,a='<li class="addNewCost"><input type="text" /><input type="text" /><i class="btn-del"></i></li>';$(".addCost").on("click",function(){var t=$(this),n=t.parents(".responseBox").find(".responseCost"),o=n.find("li:last-child").find("input");e=!0,o.length>1&&o.forEach(function(a){return""==a.value?($("#formTip").html("此项费用完成后才能继续新增费用！").addClass("formTipShow"),void(e=!1)):void 0}),e&&n.append(a)})},cancel:function(e,a){var t=this;t.itemshow(e,a)},save:function(e,a){var t=this,n=e.parents(".m-item");if(n.is("#prodAnswerInfo")){{var o=e.parents(".responseBox").find("li.myResponse");o.length}t.createResponse($(".myResponse"),3,e,a,"isProdAnswer")}else if(n.is("#othersCost")){for(var i=$(".original").length,s=0;i>s;s++){var r=$(".original").eq(s).val();""!=r&&(othersCostCon.find(".dj").eq(s).html($currencySymbol+'<em class="money" data-money="'+r+'">'+formatMoney(r)+"</em>"),othersCostCon.find(".mobiCostItem").attr("data-vcostamount",r))}t.createResponse($(".addNewCost"),2,e,a,"isOtherCost")}},createResponse:function(e,a,t,n,o){for(var i=this,s=e.length,r="",l=new Array,c=$scope.poLineList,d=t.parents(".responseBox").attr("data-index"),p=0;s>p;p++){l[p]=new Array;for(var m=0;a>m;m++){var v=e.eq(p).find("input").eq(m),u=v.val();if(""==u)return v.focus(),!1;l[p][m]=u}}for(var f=0;s>f;f++)r+="isProdAnswer"==o?c[d].unitName?'<li class="response responseBatch"><section><span'+(0==f?' class="nth0"':"")+'>分批答交：</span><em class="purchaseQty">'+l[f][0]+"</em>"+c[d].purchaseUnitName+'/<em class="valuationQty">'+l[f][1]+"</em>"+c[d].valuationUnitName+'</section><section><span>交期：</span><em class="expectedDelivery">'+l[f][2]+"</em></section></li>":'<li class="response responseBatch"><section><span'+(0==f?' class="nth0"':"")+'>分批答交：</span><em class="purchaseQty">'+l[f][0]+"</em>"+c[d].purchaseUnitName+'<em class="hidden valuationQty">'+l[f][1]+'</em></section><section><span>交期：</span><em class="expectedDelivery">'+l[f][2]+"</em></section></li>":'<li class="costItem response" data-costName="'+l[f][0]+'" data-costAmount="0" data-vCostAmount="'+l[f][1]+'"><span><em>'+l[f][0]+"</em>：</span><b>"+$currencySymbol+'0.00</b><b class="dj">'+$currencySymbol+'<em class="money" data-money="'+l[f][1]+'">'+formatMoney(l[f][1])+"</em></b></li>";if(i.itemshow(t,n),n.find(".item-wrap").eq(d).find(".response").remove(),n.find(".item-wrap").eq(d).find(".bfline").remove(),"isProdAnswer"==o){s>0?(n.find(".item-wrap").eq(d).find(".bfline").hide(),n.find(".item-wrap").eq(d).find(".price").before(r)):(n.find(".item-wrap").eq(d).find(".bfline").show(),n.find(".item-wrap").eq(d).find(".price").before($scope.poLineList[d].unitName?'<li class="bfline"><section><span>本方数量：</span><em class="vPurchaseQty">'+$scope.poLineList[d].vPurchaseQty+"</em>"+$scope.poLineList[d].purchaseUnitName+'/<em class="vValuationQty">'+$scope.poLineList[d].vValuationQty+"</em>"+$scope.poLineList[d].valuationUnitName+'</section><section><span>交期：</span><em class="vExpectedDelivery">'+$scope.poLineList[d].vExpectedDelivery+"</em></section></li>":'<li class="bfline"><section><span>本方数量：</span><em class="vPurchaseQty">'+$scope.poLineList[d].vPurchaseQty+"</em>"+$scope.poLineList[d].purchaseUnitName+'<em class="hidden vValuationQty">'+$scope.poLineList[d].vValuationQty+'</em></section><section><span>交期：</span><em class="vExpectedDelivery">'+$scope.poLineList[d].vExpectedDelivery+"</em></section></li>"));var h=i.reQtys(t.parents(".responseBox"),d);if(""!=h||void 0!=h){var y=n.find(".item-wrap").eq(d).find(".subtotal"),b=(y.attr("data-total"),n.find(".item-wrap").eq(d).find(".price")),P=(b.attr("data-taxPrice"),b.attr("data-price"),0);P=h*$scope.poLineList[d]._vTaxPrice,y.attr("data-vtotal",P),n.find(".item-wrap").eq(d).find("ul").append('<li class="response responseTotal" data-vLineAmount="'+h*$scope.poLineList[d]._vPrice+'" data-vTaxLineTotal="'+h*$scope.poLineList[d]._vTaxPrice+'"><span>答交金额：</span>'+$currencySymbol+formatMoney(P,$amountDecimalNum)+"</li>")}}else{$("#othersCostSubtotal").before(r);var L=0;othersCostCon.find(".costItem").forEach(function(e){L+=parseFloat($(e).attr("data-vcostamount"))}),$("#othersCostSubtotal").attr("data-vtotal",L),$("#othersCostSubtotal").after('<li id="changeCost" class="response" data-otherMoney="'+L+'"><span>本方小计：</span>'+$currencySymbol+formatMoney(L,$amountDecimalNum)+"</li>")}$(".item-total-dj").attr("data-vTotalAmount",i.reCostTotalFn()).html("答交总金额："+$currencySymbol+formatMoney(i.reCostTotalFn(),$amountDecimalNum)).show()},modiResponse:function(e,a){var t=e.parents(".responseBox").eq(0).find(".bfline").eq(0);$scope.poLineList[a].vPurchaseQty=t.find("input").eq(0).val(),$scope.poLineList[a].vValuationQty=t.find("input").eq(1).val(),$scope.poLineList[a].vExpectedDelivery=t.find("input").eq(2).val()},delResponse:function(){var e=this,a="<p>您确定要删除此条答交？</p>";container.on("click",".btn-del",function(){var t=$(this),n=t.parent("li"),o=t.parents(".responseBox"),i=t.parents(".responseBox1"),s=o.attr("data-index");e.popup("confirm","",a,"",function(){if(n.remove(),t.parent("li").is(".myResponse")){if(0==i.find(".myResponse").length)return o.removeClass("batchBox"),i.find(".int01_all").prop("disabled",!1),i.find(".int01_all").val($scope.poLineList[s].purchaseQty),i.find(".int02_all").val($scope.poLineList[s].valuationQty),!1;{var e=0,a=0;i.find(".int01_all").val(),i.find(".int02_all").val()}i.find(".int01").forEach(function(a){e+=parseFloat(a.value||0)}),i.find(".int02").forEach(function(e){a+=parseFloat(e.value||0)}),i.find(".int01_all").val(e),i.find(".int02_all").val(a)}})})},dateFn:function(){$(".timeBox").mdater({maxDate:null,minDate:new Date})},hideTip:function(){$body.on("focus",'input[type="text"]',function(){$("#formTip").removeClass("formTipShow")})},reQtys:function(e){var a=0;return 0==e.find(".myResponse").length?a=e.find(".int02_all").val():e.find(".int02").each(function(){var e=$(this);a+=parseFloat(e.val())}),a},reQtysAll:function(e){var a=e.attr("name"),t=e.parents(".responseBox"),n=0;t.find("."+a).forEach(function(e){n+=parseFloat($(e).val())}),t.find("."+a+"_all").val(n)},reCostTotalFn:function(){var e=0;return container.find(".subtotal").each(function(){e+=parseFloat($(this).attr("data-vtotal"))}),e},start:function(){function e(){var e;$scope.poLineList.forEach(function(t,n){e="",t.vFileList=[];var o={token:_vParams.token,secretNumber:_vParams.secretNumber,serviceId:"B01_findFileList",companyId:a.orderInfo.companyId,id:t.id,commonParam:commonParam(),docType:"24",fileSource:1,searchType:2};GetAJAXData("POST",o,function(a){if(a.success){for(var o=0;o<a.fileList.length;o++)e+='<a href="'+a.fileList[o].fileUrl+'"><i class=i-'+(_reg.test(a.fileList[o].fileName)?"image":"word")+"></i>"+a.fileList[o].fileName+"</a>";a.fileList.length>0&&prodAnswerCon.find(".files").eq(n).html("<span>附件：</span><p>"+e+"</p>").show(),t.vFileList=a.fileList}},!0)})}var a=this;orderAnswerCon.html(a.orderBaseInfo()),prodAnswerCon.html(a.prodAnswerInfo()),othersCostCon.html(a.othersCost()),$(".item-total").html("订单总金额："+$currencySymbol+formatMoney(a.orderInfo.cTotalAmount,$amountDecimalNum)).show(),1!=a.vStatus&&4!=a.vStatus&&$(".item-total-dj").attr("data-vTotalAmount",a.reCostTotalFn()).html("答交总金额："+$currencySymbol+formatMoney(a.orderInfo.vTotalAmount||a.orderInfo.cTotalAmount,$amountDecimalNum)).show(),e();var t={token:_vParams.token,secretNumber:_vParams.secretNumber,serviceId:"B01_findFileList",companyId:_vParams.vendorId,id:a.orderInfo.id,commonParam:commonParam(),docType:"24",fileSource:2,searchType:1};GetAJAXData("POST",t,function(e){e.success&&($fileData=e)},!0),a.load&&(1==a.vStatus?bottomBar(["share"],a.memberId,"","接收订单","拒绝订单"):2==a.vStatus?bottomBar(["share"],a.memberId,"","提交答交","拒绝订单"):3==a.vStatus?bottomBar(["share"],a.memberId,"","提醒确认"):4==a.vStatus&&bottomBar(["share"],a.memberId,"","转销售订单")),container.on("click","a.item-link",function(){var e=$(this),t=e.attr("name"),n=$body.scrollTop();switch(t){case"payInfo":orderReviseInfoCon.html(a.payInfo(n));break;case"remark":orderReviseInfoCon.html(a.remark(n)),$("#intRemarks").val($("#vRemark").val())}$body.scrollTop(0),container.addClass("contarinEdit"),$("#jBottom").addClass("m-bottom-hide")}).on("click",".btn-wrap .btnB",function(){var e=$(this),a=e.attr("data-scrollTop");e.is("#saveRemark")&&$("#vRemark").val($("#intRemarks").val()),container.removeClass("contarinEdit"),$("#jBottom").removeClass("m-bottom-hide"),setTimeout(function(){$body.scrollTop(a)},200)}),$body.on("click",".bottom-btn-confirm",function(){if(1==a.vStatus){var e={token:_vParams.token,secretNumber:_vParams.secretNumber,serviceId:"B03_vendorReceivePoAnswer",poAnswerId:_vParams.poAnswerId,companyId:a.orderInfo.companyId,vendorId:_vParams.vendorId,commonParam:commonParam()};a.vendorPoAnswer(e)}if(2==a.vStatus&&a.popup("confirm","","您确定提交答交吗？",function(){},function(){a.submitFn(function(){fnTip.success(2e3),setTimeout(function(){window.location.reload(!0)},2e3)})}),3==a.vStatus){var t={token:_vParams.token,secretNumber:_vParams.secretNumber,serviceId:"B03_poRemindAnswer",poId:a.orderInfo.purchaseOrderId,companyId:a.orderInfo.companyId,commonParam:commonParam()};a.vendorPoAnswer(t,function(){setTimeout(function(){goBack()},2e3)},!0)}4==a.vStatus&&(window.location.href=config.htmlUrl+'orderRevise.html?param={"poAnswerId":"'+_vParams.poAnswerId+'","companyId":"'+_vParams.vendorId+'","secretNumber":"'+_vParams.secretNumber+'","token":"'+_vParams.token+'"}')}),$body.on("click",".bottom-btn-cancel",function(){(1==a.vStatus||2==a.vStatus)&&a.popup("confirm","","您确定要拒绝接单么？<br/>拒绝后的订单，将不能恢复。",function(){},function(){var e={token:_vParams.token,secretNumber:_vParams.secretNumber,serviceId:"B03_vendorRefuseReceivePoAnswer",poAnswerId:_vParams.poAnswerId,vendorId:_vParams.vendorId,commonParam:commonParam()};a.vendorPoAnswer(e,function(){setTimeout(function(){goBack()},2e3)},!0)})})},payInfo:function(e){var a=this,t=a.orderInfo,n='<ul class="payInfoList"><li><span>交易条件：</span><p>'+t.conditionName+"</p></li><li><span>物流方式：</span><p>"+enumFn(a.logisticsType,t.logisticsType)+"</p></li><li><span>"+(3==t.logisticsType?"自提点":"收货地址")+"：</span><p>"+t.provinceName+t.cityName+t.districtName+t.address+"<br>收货人："+t.contactPerson+"，电话："+t.mobile+"</p></li><li><span>付款条件：</span><p>"+t.payWayName+"</p></li>";return n+=1==t.invoice?"<li><span>发票信息：</span><p>"+enumFn(a.invoiceInfoName,t.invoice)+"</p></li>":"<li><span>发票类型：</span><p>"+enumFn(a.invoiceType,t.invoiceType)+"</p></li><li><span>发票抬头：</span><p>"+t.invoiceHeader+"</p></li><li><span>发票类容：</span><p>"+t.invoiceContent+"</p></li>",n+='</ul><div class="btn-wrap"><a href="javascript:;" class="btnB" data-scrollTop="'+e+'">返回</a></div>'},remark:function(e){var a=this,t='<div class="remarks-wrap"><div id="provisions" class="item-wrap clause">	<h2>补充条款：</h2>	<p>'+a.orderInfo.agreement+'</p></div><div id="taRemarks" class="item-wrap taRemarks">	<h2>备注信息：</h2>	<p>'+a.orderInfo.remark+'</p></div><div id="files" class="item-wrap attachment">	<h2>订单附件：</h2>';0==$fileData.fileList.length&&(t+="<p><b>0个附件</b></p>");for(var n=0;n<$fileData.fileList.length;n++)t+='<p><a href="'+$fileData.fileList[n].fileUrl+'"><i class=i-'+(_reg.test($fileData.fileList[n].fileName)?"image":"word")+"></i>"+$fileData.fileList[n].fileName+"</a></p>";return t+="</div>",2==a.vStatus&&(t+='<div class="item-wrap int-remarks">	<textarea name="" id="intRemarks" placeholder="填写本方备注"></textarea></div>'),1!=a.vStatus&&2!=a.vStatus&&(t+='<div class="item-wrap">	<h2>本方备注：</h2>	<p>'+a.orderInfo.vRemark+"</p></div>"),t+='</div></div><div class="btn-wrap"><a href="javascript:;" id="saveRemark" class="btnB" data-scrollTop="'+e+'">完成</a></div>'},popup:function(e,a,t,n,o){new Popup({type:e,title:a,content:t,ok:"确定",cancel:"取消",closeCallBack:n,okCallBack:o})},countQtyRate:function(e){isEmpty(e)||(e.countQtyRate=parseFloat(e.valuationQty)/parseFloat(e.purchaseQty))},vTotal:function(){var e=0;return prodAnswerCon.find(".responseTotal").forEach(function(a){e+=parseFloat($(a).attr("data-vlineamount"))}),e},getParam:function(){for(var e=this,a=(e.orderInfo||[],[]),t=[],n=e._othersCost||[],o=$scope.poLineList||[],i=e._files||[],s=[],r=[],l=[],c=0,d=n.length;d>c;c++)n[c].vCostAmount=othersCostCon.find(".mobiCostItem").eq(c).find(".dj .money").attr("data-money"),t.push(n[c]);for(var p,m=othersCostCon.find(".costItem.response"),v=0,u=m.length;u>v;v++)p={vCostAmount:parseFloat(m.eq(v).attr("data-vcostamount")),costName:m.eq(v).attr("data-costname"),isNewAdd:!0,costSource:2,costAmount:0,remark:"",vRemark:"",lineNo:v+1},a.push(p);for(var f,h=[],y=0,b=o.length;b>y;y++){var P=prodAnswerCon.find(".item-wrap").eq(y),L=(P.find(".responseTotal").eq(0),P.find(".response").not(".responseTotal")),N=(P.find(".bfline"),{}),I=!1;f=o[y],f.addPoLineFileList=[],f.addPoSubLineList=[],f.modiPoSubLineList=[];for(var x=[],C=0,T=f.poSubLineList.length;T>C;C++){var w=f.poSubLineList[C];x.push(w.subId)}if(L.forEach(function(e,a){var t={};t.expectedDelivery=new Date($(e).find(".expectedDelivery").html()).getTime(),t.purchaseQty=$(e).find(".purchaseQty").html(),t.purchaseUnit=f.purchaseUnitName,t.valuationQty=$(e).find(".valuationQty").html(),t.valuationUnit=f.valuationUnitName,t.lineNo=a+1,f.addPoSubLineList.push(t),I=!0}),f.danShenfileList)for(var S=0,A=f.danShenfileList.length;A>S;S++){var _=f.danShenfileList[S];_.isDeleted?f.delPoLineFileList.push(_.id):_.id||f.addPoLineFileList.push({lineNo:_.lineNo,fileUrl:_.fileUrl,fileSize:_.fileSize,fileName:_.fileName})}N.poAnswerLineId=f.id,N.vProdId=f.vProdId,N.vProdCode=$.trim(f.vProdCode),N.vProdDesc=$.trim(f.vProdDesc),N.vProdScale=$.trim(f.vProdScale),N.vProdName=$.trim(f.vProdName),N.vPurchaseQty=f.vPurchaseQty,N.vValuationQty=f.vValuationQty,N.vExpectedDelivery=new Date(f.vExpectedDelivery).getTime(),N.vPrice=formatMoney(f._vPrice,$priceDecimalNum),N.vTaxPrice=formatMoney(f._vTaxPrice,$priceDecimalNum),N.vLineAmount=formatMoney(f.vValuationQty*f._vPrice,$amountDecimalNum),N.vTaxLineTotal=formatMoney(f.vValuationQty*f._vTaxPrice,$amountDecimalNum),N.vAnswerUnitId=f.vAnswerUnitId,N.vAnswerUnitCode=f.vAnswerUnitCode,N.vAnswerUnitName=f.vAnswerUnitName,N.vValuationUnitId=f.vValuationUnitId,N.vValuationUnitCode=f.vValuationUnitCode,N.vValuationUnitName=f.vValuationUnitName,N.isBatchAnswer=I?1:f.vBatchAnswer,N.vRemark=f.vRemark,N.addPoSubLineList=f.addPoSubLineList?f.addPoSubLineList:[],N.modiPoSubLineList=f.modiPoSubLineList?f.modiPoSubLineList:[],N.delPoSubLineList=x?x:[],N.vFileCount=f.addPoLineFileList.length,N.addPoLineFileList=f.addPoLineFileList?f.addPoLineFileList:[],N.delPoLineFileList=f.delPoLineFileList?f.delPoLineFileList:[],h.push(N)}for(var D=0,Q=i.length;Q>D;D++){var g=i[D];g.isDeleted?s.push(g.id):g.id||r.push({lineNo:g.lineNo,fileUrl:g.fileUrl,fileSize:g.fileSize,fileName:g.fileName})}var U=parseFloat($("#changeCost").attr("data-othermoney")),k=parseFloat($(".item-total-dj").eq(0).attr("data-vtotalamount")),B=k-U;return{vStatus:3,poAnswerId:_vParams.poAnswerId,vendorId:_vParams.vendorId,serviceId:"B03_saveAnswerPo",commonParam:commonParam(),modiPoLineList:h,addPoOtherCostList:a,modiPoOthreCostList:t,delPoOthreCostList:l,vFeeInfo:{vTotal:formatMoney(e.vTotal(),$amountDecimalNum),vOtherCostTotal:formatMoney(U,$amountDecimalNum),vTaxTotal:formatMoney(B,$amountDecimalNum),vTotalAmount:formatMoney(k,$amountDecimalNum)},addPoFileList:r,delPoFileList:s,vRemark:$("#vRemark").val(),lockVersion:e.orderInfo.lockVersion}},submitFn:function(e){var a=this,t=a.getParam();t.token=_vParams.token,t.secretNumber=_vParams.secretNumber,$.ajax({type:"POST",url:config.serviceUrl,data:{param:JSON.stringify(t)},success:function(a){a=a||{},a.success?e&&e():fnTip.error(2e3)}})},vendorPoAnswer:function(e,a,t){var n=this;$.ajax({type:"POST",url:config.serviceUrl,data:{param:JSON.stringify(e)},success:function(e){if(e=e||{},e.success){if(fnTip.success(2e3),a&&a(),t)return;setTimeout(function(){window.location.reload(!0)},2e3)}else n.popup("alert","","提交失败："+e.errorMsg)}})}};