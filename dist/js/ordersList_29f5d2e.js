var formTip='<div id="formTip" class="formTip"></div>',$itemTips=$(".item-tips"),container=$(".contarin"),orderReviseInfoCon=$("#orderReviseInfoCon"),_vParams=JSON.parse(decodeURI(getQueryString("param"))),_reg=/^(\s|\S)+(jpg|jpeg|png|gif|bmp|JPG|JPEG|PNG|GIF|BMP)+$/,Lists=function(){this.init()};Lists.prototype={init:function(){var e=this;e._files=[],e._lineLists=[],e._othersCost=[],e.status,e.vStatus,e.totals=0,e.load=!1,e.memberId="",e.start(),container.on("click","span.edit",function(){var a=$(this),t=a.parent(".item-wrap"),s=t.attr("data-index");return a.is(".editOther")?(e.editResponseCost(t,s),e.addNewCost(),!1):(e.editResponse(t,s),void e.addNewResponse(s))}),$("#prodAnswerInfo").on("input","input.int02",function(){var a=$(this),t=0,s=a.parents(".responseBox"),n=s.attr("data-index"),o=a.val(),r=e._lineLists[n].valuationQty;t=e.reQtys(s,n),o>r-(t-o)&&a.val(r-(t-o))}),e.dateFn(),e.hideTip(),$(".item-total").html("总金额：&yen;"+formatMoney(e.totals)).show(),3==e.status&&$(".item-total-dj").html("答交总金额：&yen;"+formatMoney(e.reCostTotalFn())).show(),e.delResponse()},orderBaseInfo:function(){var e=this,a="",t={serviceId:"B03_getPurchaseOrderAnswerInfo",poAnswerId:_vParams.poAnswerId,vendorId:_vParams.vendorId,commonParam:commonParam(),token:_vParams.token,secretNumber:_vParams.secretNumber};return $.ajax({type:"POST",async:!1,url:config.serviceUrl,data:"param="+JSON.stringify(t),success:function(t){t=t||{},t.success&&(e.orderInfo=t.poAnswerOrderInfo,e.memberId=e.orderInfo.auditid,e.status=e.orderInfo.status,e.vStatus=e.orderInfo.vStatus,a+='<h2 class="m-title">基本信息</h2><div class="item-wrap">	<ul>		<li><span>平台单号：</span><b>'+e.orderInfo.poFormNo+"</b></li>		<li><span>内部单号：</span><b>"+e.orderInfo.poInsideNo+"</b></li>		<li><span>客户：</span>"+e.orderInfo.companyName+"</li>		<li><span>交易货币：</span>"+e.orderInfo.currencyName+"</li>		<li><span>交易税种：</span>"+e.orderInfo.taxName+(1===e.orderInfo.isContainTax?'<label class="checkbox on"><input type="checkbox" checked="checked" disabled>含税'+100*e.orderInfo.taxRate+"%</label>":"")+"</li>		<li><span>采购日期：</span>"+e.orderInfo.poFormDate+"</li>	</ul></div>")}}),a},fileList:function(){var e=this;if(e.load){var a={secretNumber:_vParams.secretNumber,token:_vParams.token,serviceId:"B01_findFileList",companyId:_vParams.companyId,commonParam:commonParam(),fileSource:"2",searchType:"2",id:e.orderInfo.id.toString(),docType:"12"};$.ajax({type:"POST",url:config.serviceUrl,data:"param="+JSON.stringify(a),success:function(a){if(a=a||{},a.success){for(var t=a.fileList,s=0,n=t.length;n>s;s++)""!=t[s].fileName&&$(".files").eq(s).html('<span>附件：</span><a href="'+t[s].fileUrl+'"><i class=i-'+(_reg.test(t[s].fileName)?"image":"word")+"></i>"+t[s].fileName+"</a>").show();e._files=t}}})}},prodAnswerInfo:function(){var e=this,a="",t={serviceId:"B03_findPoAnswerLineList",poAnswerId:_vParams.poAnswerId,vendorId:_vParams.vendorId,commonParam:commonParam(),token:_vParams.token,secretNumber:_vParams.secretNumber};return $.ajax({type:"POST",async:!1,url:config.serviceUrl,data:"param="+JSON.stringify(t),success:function(t){if(t=t||{},t.success){var s=t.poLineList;e._lineLists=s,a='<h2 class="m-title">产品信息</h2>';for(var n=0,o=s.length;o>n;n++){a+='<div class="item-wrap" data-index="'+n+'">	<ul>		<li class="prodCode" data-prodCode="'+s[n].prodCode+'" data-prodId="'+s[n].prodId+'"><span>物料编码：</span><b>'+s[n].prodCode+"</b></li>		<li><span>物料详细：</span><p>"+s[n].prodName+" "+s[n].prodScale+"</p></li>		<li><section><span>数量：</span><em>"+s[n].purchaseQty+"</em>"+s[n].purchaseUnitName+"/<em>"+s[n].valuationQty+"</em>"+s[n].valuationUnitName+"</section><section><span>交期：</span><em>"+s[n].expectedDelivery+"</em></section></li>";for(var r=0;r<s[n].poSubLineList.length;r++)a+='<li class="response"><section><span>数量：</span><em>'+s[n].poSubLineList[r].purchaseQty+"</em>"+s[n].purchaseUnitName+"/<em>"+s[n].poSubLineList[r].valuationQty+"</em>"+s[n].valuationUnitName+"</section><section><span>交期：</span><em>"+s[n].poSubLineList[r].expectedDelivery+"</em></section></li>";a+='		<li class="price" data-price="'+(1===e.orderInfo.isContainTax?s[n].taxPrice:s[n].price)+'"><span>单价：</span>&yen; '+formatMoney(1===e.orderInfo.isContainTax?s[n].taxPrice:s[n].price)+"/"+s[n].valuationUnitName+"</li>		<li><span>备注：</span><p>"+s[n].remark+'</p></li>		<li class="files"><span>附件：</span></li>'+(1===e.orderInfo.isContainTax?'<li class="subtotal" data-total="'+s[n].taxLineTotal+'" data-vTotal="'+(""!=s[n].vTaxLineTotal||0!=s[n].vTaxLineTotal?s[n].vTaxLineTotal:s[n].taxLineTotal)+'"><span>小计：</span><b>&yen; '+formatMoney(s[n].taxLineTotal)+"</b></li>":'<li class="subtotal" data-total="'+s[n].lineAmount+'" data-vTotal="'+(""!=s[n].vLineAmount||0!=s[n].vLineAmount?s[n].vLineAmount:s[n].lineAmount)+'"><span>小计：</span><b>&yen; '+formatMoney(s[n].lineAmount)+"</b></li>")+(s[n].poSubLineList.length>0?'<li class="response responseTotal"><span>答交金额：</span>&yen; '+formatMoney(s[n].vTaxLineTotal)+"</li>":"")+"	</ul>"+(2==e.vStatus?'<span class="edit"></span>':"")+"</div>",e.totals+=parseInt(s[n].taxLineTotal,10)}e.load=!0,setTimeout(function(){container.show(),fnTip.hideLoading()},0)}else fnTip.hideLoading(),container.show().html('<p style="line-height:2rem; text-align:center">'+t.errorMsg+"</p>")}}),a},editResponse:function(e,a){function t(){var a=e.find(".response").not(".responseTotal"),t=a.length,s="";if(0!=t)for(var n=0;t>n;n++){var o=a.eq(n).find("em");s+='<li class="myResponse"><span>答交：</span><input type="text" class="int01" value="'+o.eq(0).html()+'"><input type="text" class="int02" value="'+o.eq(1).html()+'"><div class="timeBox">'+o.eq(2).html()+'</div><input type="hidden" value="'+o.eq(2).html()+'"><i class="btn-del"></i></li>'}return s}var s,n,o,r=this,i=r._lineLists,l=i[a].prodCode,p=r.orderInfo.companyId,c={serviceId:"B01_getProdByCustomerProd",token:_vParams.token,secretNumber:_vParams.secretNumber,vendorId:_vParams.vendorId,cProdCode:l,commonParam:commonParam(),customerId:p};$.ajax({type:"POST",async:!1,url:config.serviceUrl,data:"param="+JSON.stringify(c),success:function(e){$(".ball-clip-rotate").remove(),e=e||{},e.success&&(s=e.prodMap.prodCode,n=e.prodMap.prodName,o=e.prodMap.prodScale)}});var d='<div class="responseBox" data-index="'+a+'"><ul class="responseBox1">	<li>		<span>对方：</span>		<p>物料编码：'+i[a].prodCode+"<br>"+i[a].prodName+" "+i[a].prodScale+'</p>	</li>	<li class="myProductInfo">		<span>我方：</span>		<p>物料编码：'+s+"<br>"+n+" "+o+"</p>	</li>	<li><span>数量：</span><em>"+i[a].purchaseQty+i[a].purchaseUnitName+" /</em><em>"+i[a].valuationQty+i[a].valuationUnitName+'</em><span>交期：</span><em class="em03">'+i[a].expectedDelivery+"</em></li>"+t()+'</ul><div class="btnBox"><a href="javascript:;" class="addResponse">新增答交栏</a></div><ul class="responseBox2">	<li><span>单价：</span>¥'+formatMoney(1===r.orderInfo.isContainTax?i[a].taxPrice:i[a].price)+"/"+i[a].valuationUnitName+"</li>	<li><span>备注：</span><p>"+i[a].remark+'</p></li>	<li class="subtotal"><span>小记：</span><b>&yen; '+formatMoney(i[a].taxLineTotal)+'</b></li></ul><div class="btns">	<a class="btn-cancel" href="javascript:;">取消</a>	<a class="btn-save" href="javascript:;">确定</a></div></div>';e.hide(),e.after(d),$body.append(formTip),$("#prodAnswerInfo").on("click",".btn-cancel",function(e){r.cancel($(this),$("#prodAnswerInfo")),e.preventDefault()}),$("#prodAnswerInfo").on("click",".btn-save",function(e){r.save($(this),$("#prodAnswerInfo")),e.preventDefault()})},itemshow:function(e,a){var t=e.parents(".responseBox").attr("data-index");e.parents(".responseBox").remove(),a.find(".item-wrap").eq(t).show(),$("#formTip").remove()},addNewResponse:function(e){var a=this,t=!0,s=a._lineLists[e].valuationQty,n='<li class="myResponse"><span>答交：</span><input type="text" class="int01" /><input type="text" class="int02" /><div class="timeBox"></div><input type="hidden" /><i class="btn-del"></i></li>';$body.on("click",".addResponse",function(){var o=$(this),r=o.parents(".responseBox"),i=r.find(".responseBox1"),l=i.find("li:last-child").find("input");t=!0,a.reQtys(r,e)!=s&&(l.length>1&&l.forEach(function(e){return""==e.value?($("#formTip").html("新增答交内容为空不能继续新增！").addClass("formTipShow"),void(t=!1)):void 0}),t&&i.append(n))})},othersCost:function(){var e=this,a="",t=0,s=0,n=!1;if(e.load){var o={token:_vParams.token,secretNumber:_vParams.secretNumber,serviceId:"B03_findPoAnswerOtherCostList",poAnswerId:_vParams.poAnswerId,vendorId:_vParams.vendorId,commonParam:commonParam()};return $.ajax({type:"POST",async:!1,url:config.serviceUrl,data:"param="+JSON.stringify(o),success:function(o){if(o=o||{},o.success){var r=o.poOthreCostList;e._othersCost=r,a='<h2 class="m-title">其他费用</h2><div class="item-wrap" data-index="0"><ul>';for(var i=0,l=r.length;l>i;i++)a+='<li data-costName="'+r[i].costName+'" data-costAmount="'+r[i].costAmount+'" data-vCostAmount="'+r[i].vCostAmount+'"><span>'+r[i].costName+"：</span><b>&yen; "+formatMoney(r[i].costAmount)+'</b><b class="dj"><em class="money" data-money="'+(""==r[i].vCostAmount?r[i].costAmount:r[i].vCostAmount)+'">'+(""==r[i].vCostAmount?"":formatMoney(r[i].vCostAmount))+"</em></b></li>",t+=parseInt(r[i].costAmount,10),s+=parseInt(""==r[i].vCostAmount?r[i].costAmount:r[i].vCostAmount,10),""!=r[i].vCostAmount&&(n=!0);a+='<li id="othersCostSubtotal" class="subtotal" data-total="'+t+'" data-vTotal="'+(n?s:t)+'"><span>小计：</span><b>&yen; '+formatMoney(t)+"</b></li>",n&&(a+='<li id="changeCost" class="response"><span>变更费用：</span>&yen; '+formatMoney(s)+"</li>"),a+="</ul>",a+=2==e.vStatus?'<span class="edit editOther"></span>':"",a+="</div>",e.totals+=parseInt(t,10)}}}),a}},editResponseCost:function(e){function a(){var a=$(e).find(".response").not("#changeCost"),t=a.length,s="";if(0!=t)for(var n=0;t>n;n++)s+='<li class="addNewCost"><input type="text" value="'+a.eq(n).attr("data-costname")+'"><input type="text" value="'+a.eq(n).attr("data-vcostamount")+'"><i class="btn-del"></i></li>';return s}for(var t=this,s=t._othersCost,n=s.length,o='<div class="responseBox" data-index="0"><ul class="responseCost">',r=0;n>r;r++){var i=""==$("#othersCost .dj").eq(r).find("em").html()?"":$("#othersCost .dj").eq(r).find("em").attr("data-money");o+="<li><span>"+s[r].costName+"：</span><b>&yen; "+formatMoney(s[r].costAmount)+'</b><input type="text" class="original" id="dj_'+r+'" value="'+i+'" /></li>'}o+=a(),o+='</ul><div class="btnBox"><a href="javascript:;" class="addCost">新增费用</a></div><div class="btns">	<a class="btn-cancel" href="javascript:;">取消</a>	<a class="btn-save" href="javascript:;">确定</a></div></div>',e.hide(),e.after(o),$body.append(formTip),$("#othersCost").on("click",".btn-cancel",function(e){t.cancel($(this),$("#othersCost")),e.preventDefault()}),$("#othersCost").on("click",".btn-save",function(e){t.save($(this),$("#othersCost")),e.preventDefault()})},addNewCost:function(){var e=!0,a='<li class="addNewCost"><input type="text" /><input type="text" /><i class="btn-del"></i></li>';$body.on("click",".addCost",function(){var t=$(this),s=t.parents(".responseBox").find(".responseCost"),n=s.find("li:last-child").find("input");e=!0,n.length>1&&n.forEach(function(a){return""==a.value?($("#formTip").html("新增费用内容为空不能继续新增！").addClass("formTipShow"),void(e=!1)):void 0}),e&&s.append(a)})},cancel:function(e,a){var t=this;t.itemshow(e,a)},save:function(e,a){var t=this,s=e.parents(".m-item");if(s.is("#prodAnswerInfo")){{var n=e.parents(".responseBox").find("li.myResponse");n.length}t.createResponse($(".myResponse"),3,e,a,"isProdAnswer")}else if(s.is("#othersCost")){for(var o=$(".original").length,r=0;o>r;r++){var i=$(".original").eq(r).val();""!=i&&$("#othersCost .dj").eq(r).html('&yen; <em class="money" data-money="'+i+'">'+formatMoney(i)+"</em>")}t.createResponse($(".addNewCost"),2,e,a,"isOtherCost")}},createResponse:function(e,a,t,s,n){for(var o=this,r=e.length,i="",l=new Array,p=o._lineLists,c=t.parents(".responseBox").attr("data-index"),d=0;r>d;d++){l[d]=new Array;for(var m=0;a>m;m++){var v=e.eq(d).find("input").eq(m),u=v.val();if(""==u)return v.focus(),!1;l[d][m]=u}}for(var f=0;r>f;f++)i+="isProdAnswer"==n?'<li class="response"><section><span>数量：</span><em>'+l[f][0]+"</em>"+p[c].purchaseUnitName+"/<em>"+l[f][1]+"</em>"+p[c].valuationUnitName+"</section><section><span>交期：</span><em>"+l[f][2]+"</em></section></li>":'<li class="response" data-costName="'+l[f][0]+'" data-costAmount="" data-vCostAmount="'+l[f][1]+'"><span><em>'+l[f][0]+'</em>：</span><b></b><b class="dj">&yen; <em class="money" data-money="'+l[f][1]+'">'+formatMoney(l[f][1])+"</em></b></li>";if(o.itemshow(t,s),s.find(".item-wrap").eq(c).find(".response").remove(),"isProdAnswer"==n){s.find(".item-wrap").eq(c).find(".price").before(i);var h=o.reQtys(t.parents(".responseBox"),c);if(""!=h||void 0!=h){var y=s.find(".item-wrap").eq(c).find(".subtotal"),b=y.attr("data-total"),I=s.find(".item-wrap").eq(c).find(".price").attr("data-price");0==h?y.attr("data-vtotal",b):y.attr("data-vtotal",h*I),""!=i&&s.find(".item-wrap").eq(c).find("ul").append('<li class="response responseTotal"><span>答交金额：</span>&yen; '+formatMoney(h*I)+"</li>")}}else{$("#othersCostSubtotal").before(i);var w=0,C=!1;s.find(".item-wrap").eq(c).find("em.money").each(function(){var e=$(this).html();""!=e&&(C=!0),e=""==e?$(this).attr("data-money"):e,w+=parseInt(e,10)}),C&&($("#othersCostSubtotal").attr("data-vtotal",w),$("#othersCostSubtotal").after('<li id="changeCost" class="response" data-otherMoney="'+w+'"><span>变更费用：</span>&yen; '+formatMoney(w)+"</li>"))}$(".item-total-dj").html("答交总金额：&yen;"+formatMoney(o.reCostTotalFn())).show()},popup:function(e,a,t,s,n){new Popup({type:e,title:a,content:t,ok:"确定",cancel:"取消",closeCallBack:s,okCallBack:n})},delResponse:function(){var e=this,a="<p>您确定要删除此条答交？</p>";container.on("click",".btn-del",function(){var t=$(this),s=t.parent("li");e.popup("confirm","",a,"",function(){s.remove()})})},dateFn:function(){$(".timeBox").mdater({minDate:new Date})},hideTip:function(){$body.on("focus",'input[type="text"]',function(){$("#formTip").removeClass("formTipShow")})},reQtys:function(e){var a=0;return e.find(".int02").each(function(){var e=$(this);a+=parseInt(e.val(),10)}),a},reCostTotalFn:function(){var e=0;return container.find(".subtotal").each(function(){e+=parseInt($(this).attr("data-vtotal"),10)}),e},start:function(){var e=this,a=document.getElementById("orderAnswerInfo"),t=document.getElementById("prodAnswerInfo"),s=document.getElementById("othersCost");a&&(a.innerHTML=e.orderBaseInfo()),t&&(t.innerHTML=e.prodAnswerInfo(),e.fileList()),s&&(s.innerHTML=e.othersCost()),e.load&&(1==e.vStatus?bottomBar(["share"],e.memberId,"","接收订单","拒绝订单"):2==e.vStatus?bottomBar(["share"],e.memberId,"","答交订单"):3==e.vStatus?bottomBar(["share"],e.memberId,"","提醒确认"):bottomBar(["share"],e.memberId,!0)),container.on("click","a.item-link",function(){var a=$(this),t=a.attr("name"),s=$body.scrollTop();switch(t){case"payInfo":orderReviseInfoCon.html(e.payInfo(s));break;case"remark":orderReviseInfoCon.html(e.remark(s)),$("#intRemarks").val($("#vRemark").val())}$body.scrollTop(0),container.addClass("contarinEdit"),$("#jBottom").addClass("m-bottom-hide")}).on("click",".btn-wrap .btnB",function(){var e=$(this),a=e.attr("data-scrollTop");e.is("#saveRemark")&&$("#vRemark").val($("#intRemarks").val()),container.removeClass("contarinEdit"),$("#jBottom").removeClass("m-bottom-hide"),setTimeout(function(){$body.scrollTop(a)},200)}),$body.on("click",".bottom-btn-confirm",function(){if(1==e.vStatus&&e.vendorPoAnswer("B03_vendorReceivePoAnswer"),2==e.vStatus&&e.submitFn(),3==e.vStatus){var a=',"poId":'+_vParams.poAnswerId;e.vendorPoAnswer("B03_poRemindAnswer",a)}}),$body.on("click",".bottom-btn-cancel",function(){1==e.vStatus&&e.vendorPoAnswer("B03_vendorRefuseReceivePoAnswer")})},payInfo:function(e){var a=this,t=a.orderInfo;requestFn("B02_LogisticsType",function(e){"0"==e.errorCode&&(a.logisticsType=e.dataSet.data.detail)}),requestFn("B02_InvoiceType",function(e){"0"==e.errorCode&&(a.invoiceType=e.dataSet.data.detail)});var s='<ul class="payInfoList"><li><span>交易条件：</span><p>'+t.conditionName+"</p></li><li><span>物流方式：</span><p>"+enumFn(a.logisticsType,t.logisticsType)+("3"==t.logisticsType?"（自提点："+t.address+"）":"")+"</p></li><li><span>收货地址：</span><p>"+t.address+"；"+(""==t.mobile?"":"<br>电话："+t.mobile)+"</p></li><li><span>付款条件：</span><p>"+t.payWayName+"</p></li><li><span>发票类型：</span><p>"+enumFn(a.invoiceType,t.invoiceType)+"</p></li><li><span>发票抬头：</span><p>"+t.invoiceHeader+"</p></li><li><span>发票类容：</span><p>"+t.invoiceContent+'</p></li></ul><div class="btn-wrap"><a href="javascript:;" class="btnB" data-scrollTop="'+e+'">完成</a></div>';return s},remark:function(e){for(var a=this,t='<div class="remarks-wrap"><div id="provisions" class="item-wrap clause">	<h2>补充条款：</h2>	<p>'+a.orderInfo.agreement+'</p></div><div id="taRemarks" class="item-wrap taRemarks">	<h2>备注信息：</h2>	<p>'+a.orderInfo.remark+'</p></div><div id="files" class="item-wrap attachment">	<h2>订单附件：</h2>',s=0;s<a._files.length;s++)t+='<p><a href="'+a._files[s].fileUrl+'"><i class=i-'+(_reg.test(a._files[s].fileName)?"image":"word")+"></i>"+a._files[s].fileName+"</a></p>";return t+="</div>",2==a.vStatus&&(t+='<div class="item-wrap int-remarks">	<textarea name="" id="intRemarks" placeholder="填写我方备注"></textarea></div>'),t+='</div></div><div class="btn-wrap"><a href="javascript:;" id="saveRemark" class="btnB" data-scrollTop="'+e+'">完成</a></div>'},popup:function(e,a,t,s,n){new Popup({type:e,title:a,content:t,ok:"确定",cancel:"取消",closeCallBack:s,okCallBack:n})},submitFn:function(){for(var e,a=new Array,t=$("#prodAnswerInfo").find(".item-wrap"),s=t.length,n=0;s>n;n++){var o=t.eq(n).find(".response").not(".responseTotal"),r=o.length,i=[];a[n]=new Array;for(var l=0;r>l;l++){var p=$(o[l]).find("em");a[n][l]={purchaseQty:p.eq(0).html(),valuationQty:p.eq(1).html(),expectedDelivery:(new Date).getTime(p.eq(2).html()).toString()},i.push(a[n][l])}a[n]={modiPoSubLineList:i}}for(var c=$("#othersCost").find("li").not("#othersCostSubtotal,#changeCost"),d=c.length,m=[],v=0;d>v;v++)m[v]={costName:c.eq(v).attr("data-costName"),costAmount:c.eq(v).attr("data-costAmount"),vCostAmount:c.eq(v).attr("data-vCostAmount")};e={modiPoLineList:a,modiPoOthreCostList:m,vRemark:$("#vRemark").val(),poAnswerId:_vParams.poAnswerId,vendorId:_vParams.vendorId,commonParam:commonParam(),token:_vParams.token,secretNumber:_vParams.secretNumber,vStatus:"3",serviceId:"B03_saveAnswerPo"},$.ajax({type:"POST",url:config.serviceUrl,data:"param="+JSON.stringify(e),success:function(e){e=e||{},e.success?(fnTip.success(2e3),setTimeout(function(){goBack()},2e3)):fnTip.error(2e3)}})},vendorPoAnswer:function(e,a){var t=this,a=a||"";$.ajax({type:"POST",url:config.serviceUrl,data:{param:'{ "token":"'+_vParams.token+'", "secretNumber":"'+_vParams.secretNumber+'", "serviceId":"'+e+'", "poAnswerId":"'+_vParams.poAnswerId+'", "companyId":"'+_vParams.companyId+'", "vendorId":"'+_vParams.vendorId+'", "commonParam":'+JSON.stringify(commonParam())+a+" }"},success:function(e){e=e||{},e.success?(fnTip.success(2e3),setTimeout(function(){goBack()},2e3)):t.popup("alert","","提交失败："+e.errorMsg)}})}};