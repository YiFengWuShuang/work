var formTip='<div id="formTip" class="formTip"></div>',$itemTips=$(".item-tips"),container=$(".contarin"),orderReviseInfoCon=$("#orderReviseInfoCon"),orderAnswerCon=$("#orderAnswerInfo"),prodAnswerCon=$("#prodAnswerInfo"),othersCostCon=$("#othersCost"),$scope={},$platformCurrencyList,$currencySymbol="",$priceDecimalNum="",$amountDecimalNum="",$prodMapList=[],$fileData,$btnTxet="分批答交",_vParams=JSON.parse(decodeURI(getQueryString("param"))),_reg=/^(\s|\S)+(jpg|jpeg|png|gif|bmp|JPG|JPEG|PNG|GIF|BMP)+$/,Lists=function(){this.init()};Lists.prototype={init:function(){var e=this;e._files=[],e._othersCost=[],e.status,e.vStatus,e.totals=0,e.load=!1,e.memberId="",setTimeout(function(){container.show(),fnTip.hideLoading()},0),e.start(),container.on("click","span.edit",function(){if($(".responseBox").length)return popup("alert","",'请先"取消/确定"未完成操作再继续！'),!1;var t=$(this),a=t.parent(".item-wrap"),o=a.attr("data-index");return t.is(".editOther")?(e.editResponseCost(a,o),e.addNewCost(),!1):void e.editResponse(a,o)}),e.dateFn(),e.hideTip(),e.delResponse()},orderBaseInfo:function(){var e=this,t="",a={serviceId:"B03_getPurchaseOrderAnswerInfo",poAnswerId:_vParams.poAnswerId,vendorId:_vParams.vendorId,commonParam:commonParam(),token:_vParams.token,secretNumber:_vParams.secretNumber};return $.ajax({type:"POST",async:!1,url:config.serviceUrl,data:"param="+JSON.stringify(a),success:function(a){a=a||{},a.success&&(e.orderInfo=a.poAnswerOrderInfo,e.memberId=e.orderInfo.poManId,e.status=e.orderInfo.status,e.vStatus=e.orderInfo.vStatus,t+='<h2 class="m-title">基础信息</h2><div class="item-wrap">	<ul>		<li><span>平台单号：</span><b>'+e.orderInfo.poFormNo+"</b></li>		<li><span>内部单号：</span><b>"+e.orderInfo.poInsideNo+"</b></li>		<li><span>客户：</span><b>"+e.orderInfo.companyCode+"-"+e.orderInfo.companyAbbr+"</b></li>		<li><span>交易币别：</span>"+e.orderInfo.currencyName+"</li>		<li><span>交易税别：</span>"+e.orderInfo.taxName+'<label class="checkbox'+(1==e.orderInfo.isContainTax?" on":"")+'"><input type="checkbox" checked="checked" disabled>含税'+100*e.orderInfo.taxRate+"%</label></li>		<li><span>交易条件：</span>"+e.orderInfo.conditionName+"</li>		<li><span>付款条件：</span>"+e.orderInfo.payWayName+"</li>		<li><span>采购日期：</span>"+e.orderInfo.poFormDate+"</li>	</ul></div>")}}),t},prodAnswerInfo:function(){var e=this,t="",a={serviceId:"B03_findPoAnswerLineList",poAnswerId:_vParams.poAnswerId,vendorId:_vParams.vendorId,commonParam:commonParam(),token:_vParams.token,secretNumber:_vParams.secretNumber};return $.ajax({type:"POST",async:!1,url:config.serviceUrl,data:"param="+JSON.stringify(a),success:function(a){if(a=a||{},a.success){$scope.poLineList=a.poLineList,t='<h2 class="m-title">产品信息</h2>';for(var o=0,n=$scope.poLineList.length;n>o;o++){t+='<div class="item-wrap" data-index="'+o+'">	<ul>		<li class="prodCode" data-prodCode="'+$scope.poLineList[o].prodCode+'" data-prodId="'+$scope.poLineList[o].prodId+'"><span>物料编码：</span><b>'+$scope.poLineList[o].prodCode+"</b></li>		<li><span>物料详细：</span><p>"+$scope.poLineList[o].prodName+" "+$scope.poLineList[o].prodScale+"</p></li>"+(4!=e.vStatus?"<li><section><span>客户数量：</span><em>"+$scope.poLineList[o].purchaseQty+"</em>"+$scope.poLineList[o].purchaseUnitName+"/<em>"+$scope.poLineList[o].valuationQty+"</em>"+$scope.poLineList[o].valuationUnitName+"</section><section><span>交期：</span><em>"+$scope.poLineList[o].expectedDelivery+"</em></section></li>":"")+(1==e.vStatus?"":0==$scope.poLineList[o].poSubLineList.length?'<li class="bfline"><section><span>本方数量：</span><em class="vPurchaseQty">'+$scope.poLineList[o].purchaseQty+"</em>"+$scope.poLineList[o].purchaseUnitName+'/<em class="vValuationQty">'+$scope.poLineList[o].valuationQty+"</em>"+$scope.poLineList[o].valuationUnitName+'</section><section><span>交期：</span><em class="vExpectedDelivery">'+$scope.poLineList[o].expectedDelivery+"</em></section></li>":"");for(var s=0;s<$scope.poLineList[o].poSubLineList.length;s++)t+='<li class="response'+(0==s?" bfline":"")+'"><section><span'+(0==s?' class="nth0"':"")+'>分批答交：</span><em class="purchaseQty">'+$scope.poLineList[o].poSubLineList[s].purchaseQty+"</em>"+$scope.poLineList[o].purchaseUnitName+'/<em class="valuationQty">'+$scope.poLineList[o].poSubLineList[s].valuationQty+"</em>"+$scope.poLineList[o].valuationUnitName+"</section><section><span"+(0==s?' class="nth0"':"")+'>交期：</span><em class="expectedDelivery">'+$scope.poLineList[o].poSubLineList[s].expectedDelivery+"</em></section></li>";t+='		<li class="price" data-taxPrice="'+$scope.poLineList[o].taxPrice+'" data-price="'+$scope.poLineList[o].price+'"><span>单价：</span>'+$currencySymbol+formatMoney(1===e.orderInfo.isContainTax?$scope.poLineList[o].taxPrice:$scope.poLineList[o].price)+"/"+$scope.poLineList[o].valuationUnitName+"</li>		<li><span>备注：</span><p>"+$scope.poLineList[o].remark+'</p></li>		<li class="files"><span>附件：</span></li>		<li class="subtotal" data-total="'+$scope.poLineList[o].taxLineTotal+'" data-vTotal="'+(""!=$scope.poLineList[o].vTaxLineTotal||0!=$scope.poLineList[o].vTaxLineTotal?$scope.poLineList[o].vTaxLineTotal:$scope.poLineList[o].taxLineTotal)+'"><span>含税小计：</span><b>'+$currencySymbol+formatMoney($scope.poLineList[o].taxLineTotal)+"</b></li>"+(1!=e.vStatus&&4!=e.vStatus?'<li class="response responseTotal" data-vLineAmount="'+$scope.poLineList[o].vLineAmount+'" data-vTaxLineTotal="'+$scope.poLineList[o].vTaxLineTotal+'"><span>答交金额：</span>'+$currencySymbol+formatMoney(""==$scope.poLineList[o].vTaxLineTotal?$scope.poLineList[o].taxLineTotal:$scope.poLineList[o].vTaxLineTotal)+"</li>":"")+"	</ul>"+(2==e.vStatus?'<span class="edit"></span>':"")+"</div>",e.countQtyRate($scope.poLineList[o]),e.totals+=parseFloat($scope.poLineList[o].taxLineTotal)}e.load=!0}else fnTip.hideLoading(),container.show().html('<p style="line-height:2rem; text-align:center">'+a.errorMsg+"</p>")}}),t},editResponse:function(e,t){function a(t){var a=e.find(".bfline");return a.find("em").eq(t).html()}function o(){var e="";if(0!=r)for(var t=0;r>t;t++){var a=i.eq(t).find("em");e+='<li class="myResponse"><span'+(0==t?' class="nth0"':"")+'>分批：</span><input type="text" class="int01" name="int01" value="'+a.eq(0).html()+'"><input type="text" class="int02" name="int02" value="'+a.eq(1).html()+'" disabled><div class="timeBox">'+a.eq(2).html()+'</div><input type="hidden" value="'+a.eq(2).html()+'"><i class="btn-del"></i></li>'}return e}var n=this,s=$scope.poLineList,i=e.find(".responseBatch"),r=i.length;r>0&&($btnTxet="新增");var l='<div class="responseBox'+(r>0?" batchBox":"")+'" data-index="'+t+'"><ul class="responseBox1">	<li>		<span>对方：</span>		<p>物料编码：'+s[t].prodCode+"<br>"+s[t].prodName+" "+s[t].prodScale+'</p>	</li>	<li class="myProductInfo">		<span>本方：</span>		<p>物料编码：'+($prodMapList[t].prodCode||"")+"<br>"+($prodMapList[t].prodName||s[t].prodName)+" "+($prodMapList[t].prodScale||s[t].prodScale)+"</p>	</li>	<li><span>数量：</span><em>"+s[t].purchaseQty+s[t].purchaseUnitName+" /</em><em>"+s[t].valuationQty+s[t].valuationUnitName+'</em><span>交期：</span><em class="em03">'+s[t].expectedDelivery+'</em></li>	<li class="bfline"><span>本方：</span><input type="text" class="int01_all" value="'+a(0)+'"'+(r>0?" disabled":"")+'><input type="text" class="int02_all" value="'+a(1)+'" disabled><div class="timeBox">'+a(2)+'</div><input type="hidden" value="'+a(2)+'"></li>'+o()+'</ul><div class="btnBox"><a href="javascript:;" class="addResponse">'+$btnTxet+'</a></div><ul class="responseBox2">	<li><span>单价：</span>¥'+formatMoney(1===n.orderInfo.isContainTax?s[t].taxPrice:s[t].price)+"/"+s[t].valuationUnitName+"</li>	<li><span>备注：</span><p>"+s[t].remark+'</p></li>	<li class="subtotal"><span>小记：</span><b>'+$currencySymbol+formatMoney(s[t].taxLineTotal)+'</b></li></ul><div class="btns">	<a class="btn-cancel" href="javascript:;">取消</a>	<a class="btn-save" href="javascript:;">确定</a></div></div>';e.hide(),e.after(l),$body.append(formTip),$body.on("input","input.int01_all",function(){var e=$(this),t=e.parents(".responseBox").attr("data-index"),a=isNaN(e.val())?0:e.val();e.val(a),e.next(".int02_all").val($scope.poLineList[t].countQtyRate*a)}),$body.on("input","input.int01",function(){var e=$(this),t=e.parents(".responseBox").attr("data-index"),a=isNaN(e.val())?0:e.val(),o=e.parents(".responseBox").find(".int01_all");n.reQtysAll($(this)),e.val(a),e.next(".int02").val($scope.poLineList[t].countQtyRate*a),o.trigger("input")}),$(".addResponse").eq(0).on("click",function(){function e(){t=0,a=0,i.find(".int01").forEach(function(e){t+=parseFloat(e.value||0)}),i.find(".int02").forEach(function(e){a+=parseFloat(e.value||0)})}var t,a,o=$(this),n=o.parents(".responseBox"),i=n.find(".responseBox1"),r=i.find("li.myResponse").find("input"),l=n.attr("data-index"),p="",c="",d=$scope.poLineList[l].expectedDelivery,m=!0;r.length>1&&r.forEach(function(e){return""==e.value?($("#formTip").html("此分批答交完成后才能继续新增分批！").addClass("formTipShow"),void(m=!1)):void 0}),e(),p=parseFloat(s[l].purchaseQty)-t,c=parseFloat(s[l].valuationQty)-a,p=0>=p?"":p,c=0>=c?"":c;var v='<li class="myResponse"><span>分批：</span><input type="text" class="int01" name="int01" value="'+p+'" /><input type="text" class="int02" name="int02" value="'+c+'" disabled /><div class="timeBox">'+d+'</div><input type="hidden" value="'+d+'" /><i class="btn-del"></i></li>';m&&(i.append(v),e(),i.find(".int01_all").val(t),i.find(".int02_all").val(a),n.addClass("batchBox"),n.find(".int01_all").prop("disabled",!0),o.html("新增"))}),$(".btn-cancel").eq(0).on("click",function(e){n.cancel($(this),prodAnswerCon),e.preventDefault()}),$(".btn-save").eq(0).on("click",function(e){e.preventDefault(),n.save($(this),prodAnswerCon),n.modiResponse($(this),t)})},itemshow:function(e,t){var a=e.parents(".responseBox").attr("data-index");e.parents(".responseBox").remove(),t.find(".item-wrap").eq(a).show(),$("#formTip").remove()},othersCost:function(){var e=this,t="",a=0,o=0,n=!1;if(e.load){var s={token:_vParams.token,secretNumber:_vParams.secretNumber,serviceId:"B03_findPoAnswerOtherCostList",poAnswerId:_vParams.poAnswerId,vendorId:_vParams.vendorId,commonParam:commonParam()};return $.ajax({type:"POST",async:!1,url:config.serviceUrl,data:"param="+JSON.stringify(s),success:function(s){if(s=s||{},s.success){var i=s.poOthreCostList;e._othersCost=i,t='<h2 class="m-title">其他费用</h2><div class="item-wrap" data-index="0"><ul>';for(var r=0,l=i.length;l>r;r++)t+='<li class="mobiCostItem costItem" data-costName="'+i[r].costName+'" data-costAmount="'+i[r].costAmount+'" data-vCostAmount="'+i[r].vCostAmount+'"><span>'+i[r].costName+"：</span><b>"+$currencySymbol+formatMoney(i[r].costAmount)+"</b>"+(1==e.vStatus||4==e.vStatus?"":'<b class="dj"><em class="money" data-money="'+(""==i[r].vCostAmount?i[r].costAmount:i[r].vCostAmount)+'">'+formatMoney(""==i[r].vCostAmount?i[r].costAmount:i[r].vCostAmount)+"</em></b>")+"</li>",a+=parseFloat(""==i[r].costAmount?0:i[r].costAmount),o+=parseFloat(""==i[r].vCostAmount?i[r].costAmount:i[r].vCostAmount),""!=i[r].vCostAmount&&(n=!0);t+=4!=e.vStatus?'<li id="othersCostSubtotal" class="subtotal" data-total="'+a+'" data-vTotal="'+(n?o:a)+'"><span>客户小计：</span><b>'+$currencySymbol+formatMoney(a)+"</b></li>":"",1!=e.vStatus&&(t+='<li id="changeCost" class="response" data-otherMoney="'+o+'"><span>本方小计：</span>'+$currencySymbol+formatMoney(o)+"</li>"),t+="</ul>",t+=2==e.vStatus?'<span class="edit editOther"></span>':"",t+="</div>",e.totals+=parseFloat(a)}}}),t}},editResponseCost:function(e){function t(){var t=$(e).find(".response").not("#changeCost"),a=t.length,o="";if(0!=a)for(var n=0;a>n;n++)o+='<li class="addNewCost"><input type="text" value="'+t.eq(n).attr("data-costname")+'"><input type="text" value="'+t.eq(n).attr("data-vcostamount")+'"><i class="btn-del"></i></li>';return o}for(var a=this,o=a._othersCost,n=o.length,s='<div class="responseBox" data-index="0"><ul class="responseCost">',i=0;n>i;i++){var r=""==$("#othersCost .dj").eq(i).find("em").html()?"":$("#othersCost .dj").eq(i).find("em").attr("data-money");s+="<li><span>"+o[i].costName+"：</span><b>"+$currencySymbol+formatMoney(o[i].costAmount)+'</b><input type="text" class="original" id="dj_'+i+'" value="'+r+'" /></li>'}s+=t(),s+='</ul><div class="btnBox"><a href="javascript:;" class="addCost">新增费用</a></div><div class="btns">	<a class="btn-cancel" href="javascript:;">取消</a>	<a class="btn-save" href="javascript:;">确定</a></div></div>',e.hide(),e.after(s),$body.append(formTip),$(".btn-cancel").eq(0).on("click",function(e){a.cancel($(this),othersCostCon),e.preventDefault()}),$(".btn-save").eq(0).on("click",function(e){a.save($(this),othersCostCon),e.preventDefault()})},addNewCost:function(){var e=!0,t='<li class="addNewCost"><input type="text" /><input type="text" /><i class="btn-del"></i></li>';$body.on("click",".addCost",function(){var a=$(this),o=a.parents(".responseBox").find(".responseCost"),n=o.find("li:last-child").find("input");e=!0,n.length>1&&n.forEach(function(t){return""==t.value?($("#formTip").html("此项费用完成后才能继续新增费用！").addClass("formTipShow"),void(e=!1)):void 0}),e&&o.append(t)})},cancel:function(e,t){var a=this;a.itemshow(e,t)},save:function(e,t){var a=this,o=e.parents(".m-item");if(o.is("#prodAnswerInfo")){{var n=e.parents(".responseBox").find("li.myResponse");n.length}a.createResponse($(".myResponse"),3,e,t,"isProdAnswer")}else if(o.is("#othersCost")){for(var s=$(".original").length,i=0;s>i;i++){var r=$(".original").eq(i).val();""!=r&&(othersCostCon.find(".dj").eq(i).html($currencySymbol+'<em class="money" data-money="'+r+'">'+formatMoney(r)+"</em>"),othersCostCon.find(".mobiCostItem").attr("data-vcostamount",r))}a.createResponse($(".addNewCost"),2,e,t,"isOtherCost")}},createResponse:function(e,t,a,o,n){for(var s=this,i=e.length,r="",l=new Array,p=$scope.poLineList,c=a.parents(".responseBox").attr("data-index"),d=0;i>d;d++){l[d]=new Array;for(var m=0;t>m;m++){var v=e.eq(d).find("input").eq(m),u=v.val();if(""==u)return v.focus(),!1;l[d][m]=u}}for(var f=0;i>f;f++)r+="isProdAnswer"==n?'<li class="response responseBatch"><section><span'+(0==f?' class="nth0"':"")+'>分批答交：</span><em class="purchaseQty">'+l[f][0]+"</em>"+p[c].purchaseUnitName+'/<em class="valuationQty">'+l[f][1]+"</em>"+p[c].valuationUnitName+'</section><section><span>交期：</span><em class="expectedDelivery">'+l[f][2]+"</em></section></li>":'<li class="costItem response" data-costName="'+l[f][0]+'" data-costAmount="0" data-vCostAmount="'+l[f][1]+'"><span><em>'+l[f][0]+"</em>：</span><b>"+$currencySymbol+'0.00</b><b class="dj">'+$currencySymbol+'<em class="money" data-money="'+l[f][1]+'">'+formatMoney(l[f][1])+"</em></b></li>";if(s.itemshow(a,o),o.find(".item-wrap").eq(c).find(".response").remove(),"isProdAnswer"==n){i>0?(o.find(".item-wrap").eq(c).find(".bfline").hide(),o.find(".item-wrap").eq(c).find(".price").before(r)):o.find(".item-wrap").eq(c).find(".bfline").show();var h=s.reQtys(a.parents(".responseBox"),c);if(""!=h||void 0!=h){var L=o.find(".item-wrap").eq(c).find(".subtotal"),y=(L.attr("data-total"),o.find(".item-wrap").eq(c).find(".price")),b=y.attr("data-taxPrice"),P=y.attr("data-price"),C=0;C=1==s.orderInfo.isContainTax?h*b:h*P*(1+s.orderInfo.taxRate),L.attr("data-vtotal",C),o.find(".item-wrap").eq(c).find("ul").append('<li class="response responseTotal" data-vLineAmount="'+h*P+'" data-vTaxLineTotal="'+h*b+'"><span>答交金额：</span>'+$currencySymbol+formatMoney(C)+"</li>")}}else{$("#othersCostSubtotal").before(r);var I=0;othersCostCon.find(".costItem").forEach(function(e){I+=parseFloat($(e).attr("data-vcostamount"))}),$("#othersCostSubtotal").attr("data-vtotal",I),$("#othersCostSubtotal").after('<li id="changeCost" class="response" data-otherMoney="'+I+'"><span>本方小计：</span>'+$currencySymbol+formatMoney(I)+"</li>")}$(".item-total-dj").attr("data-vTotalAmount",s.reCostTotalFn()).html("答交总金额："+$currencySymbol+formatMoney(s.reCostTotalFn())).show()},modiResponse:function(e,t){var a=prodAnswerCon.find(".item-wrap").eq(t).find(".bfline"),o=e.parents(".responseBox").eq(0).find(".bfline").eq(0);a.find("em").eq(0).html(o.find("input").eq(0).val()),a.find("em").eq(1).html(o.find("input").eq(1).val()),a.find("em").eq(2).html(o.find("input").eq(2).val())},popup:function(e,t,a,o,n){new Popup({type:e,title:t,content:a,ok:"确定",cancel:"取消",closeCallBack:o,okCallBack:n})},delResponse:function(){var e=this,t="<p>您确定要删除此条答交？</p>";container.on("click",".btn-del",function(){var a=$(this),o=a.parent("li"),n=a.parents(".responseBox"),s=a.parents(".responseBox1"),i=n.attr("data-index");e.popup("confirm","",t,"",function(){if(o.remove(),a.parent("li").is(".myResponse")){if(0==s.find(".myResponse").length)return n.removeClass("batchBox"),s.find(".int01_all").prop("disabled",!1),s.find(".int02_all").prop("disabled",!1),s.find(".int01_all").val($scope.poLineList[i].purchaseQty),s.find(".int02_all").val($scope.poLineList[i].valuationQty),!1;{var e=0,t=0;s.find(".int01_all").val(),s.find(".int02_all").val()}s.find(".int01").forEach(function(t){e+=parseFloat(t.value||0)}),s.find(".int02").forEach(function(e){t+=parseFloat(e.value||0)}),s.find(".int01_all").val(e),s.find(".int02_all").val(t)}})})},dateFn:function(){$(".timeBox").mdater({minDate:new Date})},hideTip:function(){$body.on("focus",'input[type="text"]',function(){$("#formTip").removeClass("formTipShow")})},reQtys:function(e){var t=0;return 0==e.find(".myResponse").length?t=e.find(".int02_all").val():e.find(".int02").each(function(){var e=$(this);t+=parseFloat(e.val())}),t},reQtysAll:function(e){var t=e.attr("name"),a=e.parents(".responseBox"),o=0;a.find("."+t).forEach(function(e){o+=parseFloat($(e).val())}),a.find("."+t+"_all").val(o)},reCostTotalFn:function(){var e=0;return container.find(".subtotal").each(function(){e+=parseFloat($(this).attr("data-vtotal"))}),e},start:function(){function e(){var e;$scope.poLineList.forEach(function(t,o){e="",t.vFileList=[];var n={token:_vParams.token,secretNumber:_vParams.secretNumber,serviceId:"B01_findFileList",companyId:a.orderInfo.companyId,id:t.id,commonParam:commonParam(),docType:"24",fileSource:1,searchType:2};GetAJAXData("POST",n,function(a){if(a.success){for(var n=0;n<a.fileList.length;n++)e+='<a href="'+a.fileList[n].fileUrl+'"><i class=i-'+(_reg.test(a.fileList[n].fileName)?"image":"word")+"></i>"+a.fileList[n].fileName+"</a>";a.fileList.length>0&&prodAnswerCon.find(".files").eq(o).html("<span>附件：</span><p>"+e+"</p>").show(),t.vFileList=a.fileList}},!0)})}function t(){for(var e=0,t=$scope.poLineList.length;t>e;e++){var o={serviceId:"B01_getProdByCustomerProd",token:_vParams.token,secretNumber:_vParams.secretNumber,vendorId:_vParams.vendorId,cProdCode:$scope.poLineList[e].prodCode,commonParam:commonParam(),customerId:a.orderInfo.companyId};GetAJAXData("POST",o,function(e){e.success&&$prodMapList.push(e.prodMap)})}}var a=this;orderAnswerCon.html(a.orderBaseInfo());var o={serviceId:"B01_queryAllPlatformCurrency",token:_vParams.token,secretNumber:_vParams.secretNumber,commonParam:commonParam()};GetAJAXData("POST",o,function(e){if(e.success){$platformCurrencyList=e;for(var t=0,o=e.platformCurrencyList.length;o>t;t++)if(e.platformCurrencyList[t].currencyCode==a.orderInfo.pCurrencyCode)return $currencySymbol=e.platformCurrencyList[t].currencySymbol,$priceDecimalNum=e.platformCurrencyList[t].priceDecimalNum,$amountDecimalNum=e.platformCurrencyList[t].amountDecimalNum,!1}}),prodAnswerCon.html(a.prodAnswerInfo()),othersCostCon.html(a.othersCost()),$(".item-total").html("订单总金额："+$currencySymbol+formatMoney(a.orderInfo.cTotalAmount)).show(),1!=a.vStatus&&4!=a.vStatus&&$(".item-total-dj").attr("data-vTotalAmount",a.reCostTotalFn()).html("答交总金额："+$currencySymbol+formatMoney(a.orderInfo.vTotalAmount||a.orderInfo.cTotalAmount)).show(),e();var n={token:_vParams.token,secretNumber:_vParams.secretNumber,serviceId:"B01_findFileList",companyId:_vParams.vendorId,id:a.orderInfo.id,commonParam:commonParam(),docType:"24",fileSource:2,searchType:1};GetAJAXData("POST",n,function(e){e.success&&($fileData=e)},!0),t(),a.load&&(1==a.vStatus?bottomBar(["share"],a.memberId,"","接收订单","拒绝订单"):2==a.vStatus?bottomBar(["share"],a.memberId,"","答交订单","拒绝订单"):3==a.vStatus?bottomBar(["share"],a.memberId,"","提醒确认"):4==a.vStatus&&bottomBar(["share"],a.memberId,"","转销售订单")),container.on("click","a.item-link",function(){var e=$(this),t=e.attr("name"),o=$body.scrollTop();switch(t){case"payInfo":orderReviseInfoCon.html(a.payInfo(o));break;case"remark":orderReviseInfoCon.html(a.remark(o)),$("#intRemarks").val($("#vRemark").val())}$body.scrollTop(0),container.addClass("contarinEdit"),$("#jBottom").addClass("m-bottom-hide")}).on("click",".btn-wrap .btnB",function(){var e=$(this),t=e.attr("data-scrollTop");e.is("#saveRemark")&&$("#vRemark").val($("#intRemarks").val()),container.removeClass("contarinEdit"),$("#jBottom").removeClass("m-bottom-hide"),setTimeout(function(){$body.scrollTop(t)},200)}),$body.on("click",".bottom-btn-confirm",function(){if(1==a.vStatus){var e={token:_vParams.token,secretNumber:_vParams.secretNumber,serviceId:"B03_vendorReceivePoAnswer",poAnswerId:_vParams.poAnswerId,companyId:a.orderInfo.companyId,vendorId:_vParams.vendorId,commonParam:commonParam()};a.vendorPoAnswer(e)}if(2==a.vStatus&&a.popup("confirm","","您确定提交答交吗？",function(){},function(){a.submitFn(function(){fnTip.success(2e3),setTimeout(function(){window.location.reload(!0)},2e3)})}),3==a.vStatus){var t={token:_vParams.token,secretNumber:_vParams.secretNumber,serviceId:"B03_poRemindAnswer",poId:_vParams.poAnswerId,companyId:a.orderInfo.companyId,commonParam:commonParam()};a.vendorPoAnswer(t,function(){setTimeout(function(){goBack()},2e3)},!0)}4==a.vStatus&&(window.location.href=config.htmlUrl+'orderRevise.html?param={"poAnswerId":"'+_vParams.poAnswerId+'","companyId":"'+_vParams.vendorId+'","secretNumber":"'+_vParams.secretNumber+'","token":"'+_vParams.token+'"}')}),$body.on("click",".bottom-btn-cancel",function(){(1==a.vStatus||2==a.vStatus)&&a.popup("confirm","","您确定要拒绝订单吗？",function(){},function(){var e={token:_vParams.token,secretNumber:_vParams.secretNumber,serviceId:"B03_vendorRefuseReceivePoAnswer",poAnswerId:_vParams.poAnswerId,vendorId:_vParams.vendorId,commonParam:commonParam()};a.vendorPoAnswer(e,function(){setTimeout(function(){goBack()},2e3)},!0)})})},payInfo:function(e){var t=this,a=t.orderInfo;requestFn("B02_LogisticsType",function(e){"0"==e.errorCode&&(t.logisticsType=e.dataSet.data.detail)}),requestFn("B02_InvoiceType",function(e){"0"==e.errorCode&&(t.invoiceType=e.dataSet.data.detail)});var o='<ul class="payInfoList"><li><span>交易条件：</span><p>'+a.conditionName+"</p></li><li><span>物流方式：</span><p>"+enumFn(t.logisticsType,a.logisticsType)+"</p></li><li><span>"+(3==a.logisticsType?"自提点":"收货地址")+"：</span><p>"+a.provinceName+a.cityName+a.districtName+a.address+"<br>收货人："+a.contactPerson+"，电话："+a.mobile+"</p></li><li><span>付款条件：</span><p>"+a.payWayName+"</p></li><li><span>发票类型：</span><p>"+enumFn(t.invoiceType,a.invoiceType)+"</p></li><li><span>发票抬头：</span><p>"+a.invoiceHeader+"</p></li><li><span>发票类容：</span><p>"+a.invoiceContent+'</p></li></ul><div class="btn-wrap"><a href="javascript:;" class="btnB" data-scrollTop="'+e+'">完成</a></div>';return o},remark:function(e){var t=this,a='<div class="remarks-wrap"><div id="provisions" class="item-wrap clause">	<h2>补充条款：</h2>	<p>'+t.orderInfo.agreement+'</p></div><div id="taRemarks" class="item-wrap taRemarks">	<h2>备注信息：</h2>	<p>'+t.orderInfo.remark+'</p></div><div id="files" class="item-wrap attachment">	<h2>订单附件：</h2>';0==$fileData.fileList.length&&(a+="<p><b>0个附件</b></p>");for(var o=0;o<$fileData.fileList.length;o++)a+='<p><a href="'+$fileData.fileList[o].fileUrl+'"><i class=i-'+(_reg.test($fileData.fileList[o].fileName)?"image":"word")+"></i>"+$fileData.fileList[o].fileName+"</a></p>";return a+="</div>",2==t.vStatus&&(a+='<div class="item-wrap int-remarks">	<textarea name="" id="intRemarks" placeholder="填写本方备注"></textarea></div>'),1!=t.vStatus&&2!=t.vStatus&&(a+='<div class="item-wrap">	<h2>本方备注：</h2>	<p>'+t.orderInfo.vRemark+"</p></div>"),a+='</div></div><div class="btn-wrap"><a href="javascript:;" id="saveRemark" class="btnB" data-scrollTop="'+e+'">完成</a></div>'},popup:function(e,t,a,o,n){new Popup({type:e,title:t,content:a,ok:"确定",cancel:"取消",closeCallBack:o,okCallBack:n})},countQtyRate:function(e){isEmpty(e)||(e.countQtyRate=parseFloat(e.valuationQty)/parseFloat(e.purchaseQty))},vTotal:function(){for(var e=prodAnswerCon.find(".item-wrap"),t=0,a=0,o=$scope.poLineList.length;o>a;a++)t+=parseFloat(e.eq(a).find(".bfline").find("em").eq(1).html())*$scope.poLineList[a].price;return t},getParam:function(){for(var e=this,t=(e.orderInfo||[],[]),a=[],o=e._othersCost||[],n=$scope.poLineList||[],s=e._files||[],i=[],r=[],l=[],p=0,c=o.length;c>p;p++)o[p].vCostAmount=othersCostCon.find(".mobiCostItem").eq(p).find(".dj .money").attr("data-money"),a.push(o[p]);for(var d,m=othersCostCon.find(".costItem.response"),v=0,u=m.length;u>v;v++)d={vCostAmount:parseFloat(m.eq(v).attr("data-vcostamount")),costName:m.eq(v).attr("data-costname"),isNewAdd:!0,costSource:2,costAmount:0,remark:"",vRemark:"",lineNo:v+1},t.push(d);for(var f,h=[],L=0,y=n.length;y>L;L++){var b=prodAnswerCon.find(".item-wrap").eq(L),P=(b.find(".responseTotal").eq(0),b.find(".response").not(".responseTotal")),C=b.find(".bfline"),I={},w=!1;f=n[L],f.addPoLineFileList=[],f.addPoSubLineList=[],f.modiPoSubLineList=[];for(var S=[],T=0,x=f.poSubLineList.length;x>T;T++){var N=f.poSubLineList[T];S.push(N.subId)}if(P.forEach(function(e,t){var a={};a.expectedDelivery=new Date($(e).find(".expectedDelivery").html()).getTime(),a.purchaseQty=$(e).find(".purchaseQty").html(),a.purchaseUnit=f.purchaseUnitName,a.valuationQty=$(e).find(".valuationQty").html(),a.valuationUnit=f.valuationUnitName,a.lineNo=t+1,f.addPoSubLineList.push(a),w=!0}),f.danShenfileList)for(var A=0,g=f.danShenfileList.length;g>A;A++){var _=f.danShenfileList[A];_.isDeleted?f.delPoLineFileList.push(_.id):_.id||f.addPoLineFileList.push({lineNo:_.lineNo,fileUrl:_.fileUrl,fileSize:_.fileSize,fileName:_.fileName})}I.poAnswerLineId=f.id,f.vProdName?(I.vProdId=f.vProdId,I.vProdCode=$.trim(f.vProdCode),I.vProdDesc=$.trim(f.vProdDesc),I.vProdScale=$.trim(f.vProdScale),I.vProdName=$.trim(f.vProdName),I.vPurchaseQty=f.vPurchaseQty,I.vValuationQty=f.vValuationQty,I.vExpectedDelivery=new Date(f.vExpectedDelivery).getTime(),I.vPrice=f.vPrice,I.vTaxPrice=f.vTaxPrice,I.vLineAmount=f.vLineAmount,I.vTaxLineTotal=f.vTaxLineTotal,I.vAnswerUnitId=f.vAnswerUnitId,I.vAnswerUnitCode=f.vAnswerUnitCode,I.vAnswerUnitName=f.vAnswerUnitName,I.vValuationUnitId=f.vValuationUnitId,I.vValuationUnitCode=f.vValuationUnitCode,I.vValuationUnitName=f.vValuationUnitName):($prodMapList[L].prodCode?(I.vProdId=$prodMapList[L].prodId,I.vProdCode=$prodMapList[L].prodCode,I.vProdDesc=$prodMapList[L].prodDesc,I.vProdScale=$prodMapList[L].prodScale,I.vProdName=$prodMapList[L].prodName):(I.vProdDesc=f.prodDesc,I.vProdScale=f.prodScale,I.vProdName=f.prodName),I.vPurchaseQty=C.find(".vPurchaseQty").html(),I.vValuationQty=C.find(".vValuationQty").html(),I.vExpectedDelivery=new Date(C.find(".vExpectedDelivery").html()).getTime(),I.vPrice=f.price.toString(),I.vTaxPrice=f.taxPrice.toString(),I.vLineAmount=(C.find(".vValuationQty").html()*f.price).toString(),I.vTaxLineTotal=(C.find(".vValuationQty").html()*f.taxPrice).toString(),I.vAnswerUnitId=f.purchaseUnitId,I.vAnswerUnitCode=f.purchaseUnitCode,I.vAnswerUnitName=f.purchaseUnitName,I.vValuationUnitId=f.valuationUnitId,I.vValuationUnitCode=f.valuationUnitCode,I.vValuationUnitName=f.valuationUnitName),I.isBatchAnswer=w?1:f.vBatchAnswer,I.vRemark=f.vRemark,I.addPoSubLineList=f.addPoSubLineList?f.addPoSubLineList:[],I.modiPoSubLineList=f.modiPoSubLineList?f.modiPoSubLineList:[],I.delPoSubLineList=S?S:[],I.vFileCount=f.addPoLineFileList.length,I.addPoLineFileList=f.addPoLineFileList?f.addPoLineFileList:[],I.delPoLineFileList=f.delPoLineFileList?f.delPoLineFileList:[],h.push(I)}for(var k=0,B=s.length;B>k;k++){var F=s[k];F.isDeleted?i.push(F.id):F.id||r.push({lineNo:F.lineNo,fileUrl:F.fileUrl,fileSize:F.fileSize,fileName:F.fileName})}var R=parseFloat($("#changeCost").attr("data-othermoney")),U=parseFloat($(".item-total-dj").eq(0).attr("data-vtotalamount")),D=U-R;return{vStatus:3,poAnswerId:_vParams.poAnswerId,vendorId:_vParams.vendorId,serviceId:"B03_saveAnswerPo",commonParam:commonParam(),modiPoLineList:h,addPoOtherCostList:t,modiPoOthreCostList:a,delPoOthreCostList:l,vFeeInfo:{vTotal:e.vTotal().toString(),vOtherCostTotal:R,vTaxTotal:D.toString(),vTotalAmount:U},addPoFileList:r,delPoFileList:i,vRemark:$("#vRemark").val(),lockVersion:e.orderInfo.lockVersion}},submitFn:function(e){var t=this,a=t.getParam();a.token=_vParams.token,a.secretNumber=_vParams.secretNumber,$.ajax({type:"POST",url:config.serviceUrl,data:{param:JSON.stringify(a)},success:function(t){t=t||{},t.success?e&&e():fnTip.error(2e3)}})},vendorPoAnswer:function(e,t,a){var o=this;$.ajax({type:"POST",url:config.serviceUrl,data:{param:JSON.stringify(e)},success:function(e){if(e=e||{},e.success){if(fnTip.success(2e3),t&&t(),a)return;setTimeout(function(){window.location.reload(!0)},2e3)}else o.popup("alert","","提交失败："+e.errorMsg)}})}};