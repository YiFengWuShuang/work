var container=$(".contarin"),prodAnswerCon=$("#prodListsInfo"),$platformCurrencyList,$currencySymbol="",$priceDecimalNum="",$amountDecimalNum="",$totalAmount=0,$vTotalAmount=0,$fileData=[],$fileData2=[],orderReviseInfoCon=$("#orderReviseInfoCon"),OrderHandedOut=function(){this.init()};OrderHandedOut.prototype={init:function(){var a=this;a.commonParam=JSON.stringify(commonParam()),a.tokens='"token":"'+_vParams.token+'","secretNumber":"'+_vParams.secretNumber+'"',a.load=!1,a.memberId="",requestFn("B03_POStatus",function(e){"0"==e.errorCode&&(a.POStatus=e.dataSet.data.detail)}),requestFn("B03_POVStatus",function(e){"0"==e.errorCode&&(a.POVNStatus=e.dataSet.data.detail)}),requestFn("B02_LogisticsType",function(e){"0"==e.errorCode&&(a.logisticsType=e.dataSet.data.detail)}),requestFn("B02_InvoiceType",function(e){"0"==e.errorCode&&(a.invoiceType=e.dataSet.data.detail)}),requestFn("B02_Invoice",function(e){"0"==e.errorCode&&(a.invoiceInfoName=e.dataSet.data.detail)}),setTimeout(function(){container.show(),fnTip.hideLoading()},0),a.start()},orderBaseInfo:function(){var a=this,e="";return $.ajax({type:"POST",async:!1,url:config.serviceUrl,data:{param:"{ "+a.tokens+', "serviceId":"B03_getPurchaseOrderInfo", "poId":"'+_vParams.poId+'", "companyId":"'+_vParams.companyId+'", "commonParam":'+a.commonParam+" }"},success:function(t){t=t||{},t.success&&(a.orderInfo=t.purchaseOrderInfo,a.memberId=a.orderInfo.vAuditid,a.status=a.orderInfo.status,a.vStatus=a.orderInfo.vStatus,$currencySymbol=a.orderInfo.currencySymbol,$priceDecimalNum=a.orderInfo.priceDecimalNum,$amountDecimalNum=a.orderInfo.amountDecimalNum,e+='<h2 class="m-title">基础信息</h2><div class="item-wrap">	<ul>		<li><span>订单单号：</span><b>'+a.orderInfo.poFormNo+"</b></li>		<li><span>内部单号：</span><b>"+a.orderInfo.poInsideNo+"</b></li>		<li><span>供应商：</span>"+a.orderInfo.vendorName+"</li>		<li><span>交易币别：</span>"+a.orderInfo.currencyName+"</li>		<li><span>交易税别：</span>"+a.orderInfo.taxName+'<label class="checkbox'+(1==a.orderInfo.isContainTax?" on":"")+'"><input type="checkbox" checked="checked" disabled>含税'+100*a.orderInfo.taxRate+"%</label></li>		<li><span>采购员：</span>"+a.orderInfo.poManName+"</li>		<li><span>订单状态：</span><strong>"+enumFn(a.POStatus,a.orderInfo.status)+"</strong></li>"+(1==a.orderInfo.status||4==a.orderInfo.status||8==a.orderInfo.status?"":"<li><span>供应商答交状态：</span>"+(3==a.orderInfo.vStatus||4==a.orderInfo.vStatus||5==a.orderInfo.vStatus?"已答交":enumFn(a.POVNStatus,a.orderInfo.vStatus))+"</li>")+"	</ul></div>")}}),e},prodsInfo:function(){function a(a){a.cFileList=[],GetAJAXData("POST",{serviceId:"B01_findFileList",docType:10,companyId:_vParams.companyId,fileSource:1,searchType:2,id:a.id,token:_vParams.token,secretNumber:_vParams.secretNumber,commonParam:commonParam()},function(e){e.success&&e.fileList.forEach(function(e){a.cFileList.push({id:e.id,fileName:e.fileName,fileSize:e.fileSize,fileUrl:e.fileUrl,lineNo:e.lineNo})})})}function e(a){a.vFileList=[],GetAJAXData("POST",{serviceId:"B01_findFileList",docType:10,companyId:_vParams.companyId,fileSource:2,searchType:2,id:a.id,token:_vParams.token,secretNumber:_vParams.secretNumber,commonParam:commonParam()},function(e){e.success&&e.fileList.forEach(function(e){a.vFileList.push({id:e.id,fileName:e.fileName,fileSize:e.fileSize,fileUrl:e.fileUrl,lineNo:e.lineNo})})})}var t=this,o="";$.ajax({type:"POST",async:!1,url:config.serviceUrl,data:{param:"{ "+t.tokens+', "serviceId":"B03_findPoLineList", "poId":"'+_vParams.poId+'", "companyId":"'+_vParams.companyId+'", "commonParam":'+t.commonParam+" }"},success:function(n){if(n=n||{},n.success){var s=n.poLineList;o='<h2 class="m-title">产品明细</h2>';for(var i=0,r=s.length;r>i;i++){var c=!0;if(s[i].purchaseUnitName==s[i].valuationUnitName&&(c=!1),o+='<div class="item-wrap">	<ul>		<li><span>物料编码：</span><b>'+s[i].prodCode+"</b></li>		<li><span>物料详细：</span><p>"+s[i].prodName+" "+s[i].prodScale+"</p></li>		<li><section><span>采购数量：</span>"+s[i].purchaseQty+s[i].purchaseUnitName+(c?"/"+s[i].valuationQty+s[i].valuationUnitName:"")+"</section><section><span>交期：</span>"+s[i].expectedDelivery+"</section></li>",3==t.status)if(s[i].poSubLineInfo.length>0)for(var l=0,m=s[i].poSubLineInfo.length;m>l;l++)o+='<li class="response"><section><span>供应方：</span>'+s[i].poSubLineInfo[l].purchaseQty+s[i].purchaseUnitName+(c?"/"+s[i].poSubLineInfo[l].valuationQty+s[i].valuationUnitName:"")+"</section><section><span>交期：</span>"+s[i].poSubLineInfo[l].expectedDelivery+"</section></li>";else o+=' <li class="response"><section><span><span>供应方：</span>'+s[i].vPurchaseQty+s[i].purchaseUnitName+(c?"/"+s[i].vValuationQty+s[i].valuationUnitName:"")+"</section><section><span>交期：</span>"+s[i].vExpectedDelivery+"</section></li>";(4==t.status||5==t.status)&&(o+=" <li><span>累计发货：</span><p>"+s[i].deliveryQty+" "+s[i].purchaseUnitName+"</p></li>  <li><span>累计签收：</span><p>"+s[i].receiveQty+" "+s[i].purchaseUnitName+"</p></li>  <li><span>累计退货：</span><p>"+s[i].returnQty+" "+s[i].purchaseUnitName+"</p></li>"),o+=(4==t.status||5==t.status?"":'<li><span class="price">单价：</span>'+$currencySymbol+(1===t.orderInfo.isContainTax?formatMoney(s[i].taxPrice,$priceDecimalNum):formatMoney(s[i].price,$priceDecimalNum))+"/"+s[i].valuationUnitName+"</li>")+"		<li><span>备注：</span><p>"+s[i].remark+'</p></li>		<li class="files"><span>附件：</span></li>'+(4==t.status?"":'<li class="vfiles"><span>答交附件：</span></li>')+(4==t.status||5==t.status?"":'<li class="subtotal" data-total="'+s[i].taxLineTotal+'" data-vTotal="'+(""!=s[i].vTaxLineTotal?s[i].vTaxLineTotal:s[i].taxLineTotal)+'"><span>含税小计：</span><b>'+$currencySymbol+formatMoney(s[i].taxLineTotal,$amountDecimalNum)+"</b></li>")+(3==t.status?'<li class="response changeLineTotal" data-changeTotal="'+(""==s[i].vTaxLineTotal?0:s[i].vTaxLineTotal)+'"><span>答交金额：</span>'+$currencySymbol+formatMoney(s[i].vTaxLineTotal,$amountDecimalNum)+"</li>":"")+"	</ul></div>",$totalAmount+=parseFloat(s[i].taxLineTotal),$vTotalAmount+=parseFloat(s[i].vTaxLineTotal),a(s[i]),e(s[i])}t.load=!0,prodAnswerCon.html(o),s.forEach(function(a,e){var t="<p>";a.cFileList.forEach(function(a){t+='<a href="'+a.fileUrl+'"><i class=i-'+(_reg.test(a.fileName)?"image":"word")+"></i>"+a.fileName+"</a>"}),t+="</p>",a.cFileList.length>0&&prodAnswerCon.find(".files").eq(e).html("<span>附件：</span>"+t).show();var o="<p>";a.vFileList.forEach(function(a){o+='<a href="'+a.fileUrl+'"><i class=i-'+(_reg.test(a.fileName)?"image":"word")+"></i>"+a.fileName+"</a>"}),o+="</p>",a.vFileList.length>0&&prodAnswerCon.find(".vfiles").eq(e).html("<span>答交附件：</span>"+o).show()})}else fnTip.hideLoading(),container.show().html('<p style="line-height:2rem; text-align:center">'+n.errorMsg+"</p>")}})},otherCostList:function(){var a=this,e="",t=0,o=0;return $.ajax({type:"POST",async:!1,url:config.serviceUrl,data:{param:'{"poId":"'+_vParams.poId+'","companyId":"'+_vParams.companyId+'","commonParam":'+a.commonParam+',"serviceId":"B03_findPoOtherCostList",'+a.tokens+"}"},success:function(n){if(n=n||{},n.success){var s=n.poOtherCostList;e='<h2 class="m-title">其他费用</h2><div class="item-wrap" data-index="0"><ul>';for(var i=0,r=s.length;r>i;i++)e+="<li><span>"+s[i].costName+"：</span><b>"+$currencySymbol+formatMoney(s[i].costAmount,$amountDecimalNum)+"</b>"+(4==a.status||5==a.status?"":'<b class="dj"><em class="money" data-money="'+(""==s[i].vCostAmount?s[i].costAmount:s[i].vCostAmount)+'">'+(""==s[i].vCostAmount?"":formatMoney(s[i].vCostAmount,$amountDecimalNum))+"</em></b>")+"</li>",t+=parseFloat(""==s[i].costAmount?0:s[i].costAmount),o+=parseFloat(""==s[i].vCostAmount?s[i].costAmount:s[i].vCostAmount);e+='<li id="othersCostSubtotal" class="subtotal"><span>小计：</span><b>'+$currencySymbol+formatMoney(t,$amountDecimalNum)+"</b></li>",4==a.status||3!=a.vStatus&&4!=a.vStatus&&5!=a.vStatus||(e+='<li id="changeCost" class="response changeLineTotal" data-changeTotal="'+o+'"><span>变更费用：</span>'+$currencySymbol+formatMoney(o,$amountDecimalNum)+"</li>"),e+="</ul></div>",$("#othersCost").html(e),$totalAmount+=parseFloat(t),$vTotalAmount+=o}}}),e},reCostTotalFn:function(){var a=0;return container.find(".changeLineTotal").each(function(){a+=parseFloat($(this).attr("data-changeTotal"))}),a},payInfo:function(a){var e=this,t=e.orderInfo,o='<ul class="payInfoList"><li><span>交易条件：</span><p>'+t.conditionName+"</p></li><li><span>物流方式：</span><p>"+enumFn(e.logisticsType,t.logisticsType)+(3!=t.logisticsType?"（物流商名称："+t.logisticsName+"）":"")+"</p></li><li><span>"+("3"==t.logisticsType?"自提点":"收货地址")+"：</span><p>"+t.provinceName+t.cityName+t.districtName+t.address+"<br>(收货人："+t.contactPerson+"，电话："+t.mobile+")</p></li><li><span>付款条件：</span><p>"+t.payWayName+"</p></li>";return o+=1==t.invoice?"<li><span>发票信息：</span><p>"+enumFn(e.invoiceInfoName,t.invoice)+"</p></li>":"<li><span>发票类型：</span><p>"+enumFn(e.invoiceType,t.invoiceType)+"</p></li><li><span>发票抬头：</span><p>"+t.invoiceHeader+"</p></li><li><span>发票类容：</span><p>"+t.invoiceContent+"</p></li>",o+='</ul><div class="btn-wrap"><a href="javascript:;" class="btnB" data-scrollTop="'+a+'">返回</a></div>'},remark:function(a){for(var e=this,t='<div class="remarks-wrap"><div id="provisions" class="item-wrap clause">	<h2>补充条款：</h2>	<p>'+e.orderInfo.agreement+'</p></div><div id="taRemarks" class="item-wrap taRemarks">	<h2>备注信息：</h2>	<p>'+e.orderInfo.remark+'</p></div><div class="files item-wrap attachment">	<h2>订单附件：</h2>',o=0;o<$fileData.length;o++)t+='<p><a href="'+$fileData[o].fileUrl+'"><i class=i-'+(_reg.test($fileData[o].fileName)?"image":"word")+"></i>"+$fileData[o].fileName+"</a></p>";if(t+="</div>",1!=e.vStatus&&2!=e.vStatus){t+='<div class="files item-wrap attachment">	<h2>答交附件：</h2>';for(var n=0;n<$fileData2.length;n++)t+='<p><a href="'+$fileData2[n].fileUrl+'"><i class=i-'+(_reg.test($fileData2[n].fileName)?"image":"word")+"></i>"+$fileData2[n].fileName+"</a></p>";t+='</div><div class="item-wrap">	<h2>答交备注：</h2>	<p>'+e.orderInfo.vRemark+"</p></div>"}return t+='</div></div><div class="btn-wrap"><a href="javascript:;" id="saveRemark" class="btnB" data-scrollTop="'+a+'">返回</a></div>'},popup:function(a,e,t,o,n){new Popup({type:a,title:e,content:t,ok:"确定",cancel:"取消",closeCallBack:o,okCallBack:n})},start:function(){function a(a){return'purchase_change_add.html?param={"changeType":"'+a+'","poId":"'+_vParams.poId+'","companyId":"'+_vParams.companyId+'","secretNumber":"'+_vParams.secretNumber+'","token":"'+_vParams.token+'"}'}var e=this;$("#orderBaseInfo").html(e.orderBaseInfo()),e.prodsInfo(),4!=e.status&&5!=e.status&&($("#otherCost").html(e.otherCostList()),$(".item-total").html("订单总金额："+$currencySymbol+formatMoney(e.orderInfo.cTotalAmount,$amountDecimalNum)).show(),1!=e.status&&2!=e.status&&$(".item-total-dj").html("供应商答交总金额："+$currencySymbol+formatMoney($vTotalAmount,$amountDecimalNum)).show()),e.load&&(1==e.status&&bottomBar(["share"],e.memberId,"","发布订单","取消订单"),2==e.status&&bottomBar(["share"],e.memberId,"","提醒答交","取消订单"),3==e.status&&((3==e.vStatus||4==e.vStatus||5==e.vStatus)&&bottomBar(["share"],e.memberId,"","同意答交差异","取消订单"),7==e.vStatus&&bottomBar(["share"],e.memberId,"","取消订单")),(4==e.status||5==e.status)&&bottomBar(["share"],e.memberId,"","我要收货"));var t={token:_vParams.token,secretNumber:_vParams.secretNumber,serviceId:"B01_findFileList",companyId:e.orderInfo.companyId,id:_vParams.poId,commonParam:commonParam(),docType:"10",searchType:1};GetAJAXData("POST",t,function(a){a.success&&a.fileList.forEach(function(a){1==a.fileSource?$fileData.push(a):$fileData2.push(a)})},!0),container.on("click","a.item-link",function(){var a=$(this),t=a.attr("name"),o=$body.scrollTop();switch(t){case"payInfo":orderReviseInfoCon.html(e.payInfo(o));break;case"remark":orderReviseInfoCon.html(e.remark(o))}$body.scrollTop(0),container.addClass("contarinEdit"),$("#jBottom").addClass("m-bottom-hide")}).on("click",".btn-wrap .btnB",function(){var a=$(this),e=a.attr("data-scrollTop");container.removeClass("contarinEdit"),$("#jBottom").removeClass("m-bottom-hide"),setTimeout(function(){$body.scrollTop(e)},200)}),$body.on("click",".bottom-btn-confirm",function(){return 1==e.status&&e.popup("confirm","","确定要发布订单吗？","",function(){e.submitFn("B03_submitPurchaseOrder",function(){fnTip.success(2e3,"发布成功"),setTimeout(function(){window.location.reload(!0)},2e3)},!0)}),2==e.status?(e.submitFn("B03_poRemindAnswer",function(){e.popup("alert","","提醒成功")}),!1):3==e.status?7==e.vStatus?(window.location.href=config.htmlUrl+a(2),!1):(window.location.href=config.htmlUrl+a(1),!1):4==e.status||5==e.status?(isAndroidMobileDevice()&&window.WebViewJavascriptBridge?window.WebViewJavascriptBridge.callHandler("goodsReceive",{param:e.orderInfo.poFormNo},function(){}):setupWebViewJavascriptBridge(function(a){a.callHandler("goodsReceive",{param:e.orderInfo.poFormNo},function(){})}),!1):void 0}),$body.on("click",".bottom-btn-cancel",function(){e.popup("confirm","","确定要取消订单吗？",function(){},function(){return 1==e.status?(e.submitFn("B03_cancelPurchaseOrder",function(){fnTip.success(2e3,"取消成功"),setTimeout(function(){window.location.reload(!0)},2e3)}),!1):void(window.location.href=config.htmlUrl+a(2))})})},submitFn:function(a,e,t){var o=this;t=t?',"lockVersion":'+o.orderInfo.lockVersion:"",$.ajax({type:"POST",url:config.serviceUrl,data:{param:"{ "+o.tokens+', "serviceId":"'+a+'", "poId":"'+_vParams.poId+'", "companyId":'+_vParams.companyId+', "commonParam":'+o.commonParam+t+" }"},success:function(a){a=a||{},a.success?e&&e():fnTip.error(2e3)}})}};