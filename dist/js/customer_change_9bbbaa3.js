var formTip='<div id="formTip" class="formTip"></div>',$itemTips=$(".item-tips"),container=$(".contarin"),orderReviseInfoCon=$("#orderReviseInfoCon"),_vParams=JSON.parse(decodeURI(getQueryString("param"))),_reg=/^(\s|\S)+(jpg|jpeg|png|gif|bmp|JPG|JPEG|PNG|GIF|BMP)+$/,$currencySymbol,Lists=function(){this.init()};Lists.prototype={init:function(){var e=this;e._files=[],e._lineLists=[],e._othersCost=[],e.load=!1,setTimeout(function(){container.show(),fnTip.hideLoading()},0),requestFn("B03_POCType",function(a){"0"==a.errorCode&&(e.changeType=a.dataSet.data.detail)}),requestFn("B03_POCReasonType",function(a){"0"==a.errorCode&&(e.changeReasons=a.dataSet.data.detail)}),requestFn("B02_LogisticsType",function(a){"0"==a.errorCode&&(e.logisticsType=a.dataSet.data.detail)}),requestFn("B02_InvoiceType",function(a){"0"==a.errorCode&&(e.invoiceType=a.dataSet.data.detail)}),requestFn("B03_POCNStatus",function(a){"0"==a.errorCode&&(e.POCNStatus=a.dataSet.data.detail)}),e.start(),$(".item-total").html("变更前总金额："+$currencySymbol+formatMoney(e.orderInfo.poTotalAmount)).show(),$(".item-total-dj").html("变更后总金额："+$currencySymbol+formatMoney(e.orderInfo.totalAmount)).show()},orderBaseInfo:function(){var e=this,a="",o={serviceId:"B03_getPocNoticeInfo",companyId:_vParams.companyId,id:_vParams.id,commonParam:commonParam(),token:_vParams.token,secretNumber:_vParams.secretNumber};return $.ajax({type:"POST",async:!1,url:config.serviceUrl,data:"param="+JSON.stringify(o),success:function(o){if(o=o||{},o.success){e.orderInfo=o.pocNoticeInfo,a+='<h2 class="m-title">变更信息</h2><div class="item-wrap">	<ul>		<li><span>客户采购单号：</span><b>'+e.orderInfo.poFormNo+"</b></li>		<li><span>内部销售单号：</span><b>"+e.orderInfo.soInsideNo+"</b></li>		<li><span>变更单状态：</span><strong>"+enumFn(e.POCNStatus,e.orderInfo.vStatus)+"</strong></li>		<li><span>变更类型：</span>"+enumFn(e.changeType,e.orderInfo.changeType)+"</li>		<li><span>变更日期：</span>"+transDate(e.orderInfo.pocFormDate)+"</li>		<li><span>变更人：</span>"+e.orderInfo.pocManName+"</li>		<li><span>变更原因：</span>"+enumFn(e.changeReasons,e.orderInfo.changeReason)+"</li>		<li><span>变更备注：</span>"+e.orderInfo.remark+"</li>	</ul></div>";var n={serviceId:"B01_queryAllPlatformCurrency",token:_vParams.token,secretNumber:_vParams.secretNumber,commonParam:commonParam()};GetAJAXData("POST",n,function(a){if(a.success){$platformCurrencyList=a;for(var o=0,n=a.platformCurrencyList.length;n>o;o++)if(a.platformCurrencyList[o].currencyCode==e.orderInfo.pCurrencyCode)return $currencySymbol=a.platformCurrencyList[o].currencySymbol,!1}})}}}),a},fileList:function(){var e=this;if(e.load){var a={secretNumber:_vParams.secretNumber,token:_vParams.token,serviceId:"B01_findFileList",companyId:_vParams.companyId,commonParam:commonParam(),fileSource:"1",searchType:"1",id:_vParams.id,docType:25};$.ajax({type:"POST",url:config.serviceUrl,data:"param="+JSON.stringify(a),success:function(a){if(a=a||{},a.success){for(var o=a.fileList,n=0,r=o.length;r>n;n++)""!=o[n].fileName&&$(".files").eq(n).html('<span>附件：</span><a href="'+o[n].fileUrl+'"><i class=i-'+(_reg.test(o[n].fileName)?"image":"word")+"></i>"+o[n].fileName+"</a>").show();e._files=o}}})}},prodBodyInfo:function(){var e=this,a="",o={serviceId:"B03_findPocNoticeLineList",companyId:_vParams.companyId,pocId:_vParams.id,commonParam:commonParam(),token:_vParams.token,secretNumber:_vParams.secretNumber};return $.ajax({type:"POST",async:!1,url:config.serviceUrl,data:"param="+JSON.stringify(o),success:function(o){if(o=o||{},o.success){var n=o.pocNoticeLineList;e._lineLists=n,a='<h2 class="m-title">采购明细</h2>';for(var r=0,t=n.length;t>r;r++)a+='<div class="item-wrap" data-index="'+r+'">	<ul>		<li class="prodCode"><span>物料编码：</span><b>'+n[r].prodCode+"</b></li>		<li><span>物料名称：</span><p>"+n[r].prodName+" "+n[r].prodScale+" "+n[r].prodDesc+"</p></li>		<li><section><span>数量：</span><em>"+n[r].purchaseQty+"</em>"+n[r].purchaseUnitName+"/<em>"+n[r].valuationQty+"</em>"+n[r].valuationUnitName+"</section><section><span>交期：</span><em>"+transDate(n[r].expectedDelivery)+'</em></section></li>		<li class="changeItem"><section><span>变更：</span><em>'+n[r].changeQty+"</em>"+n[r].purchaseUnitName+"/<em>"+n[r].changeValuationQty+"</em>"+n[r].valuationUnitName+"</section><section><span>交期：</span><em>"+transDate(n[r].changeExpectedDelivery)+'</em></section></li>		<li class="price"><span>单价：</span>'+$currencySymbol+formatMoney(1==e.orderInfo.isContainTax?n[r].taxPrice:n[r].price)+"/"+n[r].valuationUnitName+"</li>		<li><span>备注：</span><p>"+n[r].remark+'</p></li>		<li class="files"><span>附件：</span></li>		<li class="subtotal"><span>小计：</span><b>'+$currencySymbol+formatMoney(n[r].taxLineTotal)+'</b></li>		<li class="changeItem changeLineTotal"><span>变更金额：</span>'+$currencySymbol+formatMoney(n[r].changeTaxLineTotal)+"</li>	</ul></div>";e.load=!0}else container.show().html('<p style="text-align:center;">'+o.errorMsg+"</p>"),fnTip.hideLoading()}}),a},othersCost:function(){var e=this,a="";if(e.load){var o={token:_vParams.token,secretNumber:_vParams.secretNumber,serviceId:"B03_findPocNoticeOtherCostList",companyId:_vParams.companyId,pocId:_vParams.id,commonParam:commonParam()};$.ajax({type:"POST",async:!1,url:config.serviceUrl,data:"param="+JSON.stringify(o),success:function(o){if(o=o||{},o.success){var n=o.costList;e._othersCost=n,a='<h2 class="m-title">其他费用</h2><div class="item-wrap" data-index="0"><ul>';for(var r=0,t=n.length;t>r;r++)a+="<li><span>"+n[r].costName+"：</span><b>"+$currencySymbol+formatMoney(n[r].costAmount)+'</b><b class="dj"><em class="money">'+formatMoney(n[r].changeCostAmount)+"</em></b></li>";a+='<li id="othersCostSubtotal" class="subtotal"><span>小计：</span><b>'+$currencySymbol+formatMoney(e.orderInfo.poOtherCostTotal)+'</b></li><li id="changeCost" class="response changeLineTotal"><span>变更费用：</span>'+$currencySymbol+formatMoney(e.orderInfo.otherCostTotal)+"</li></ul></div>",$("#othersCost").html(a)}}})}},start:function(){var e=this,a=document.getElementById("orderHeadInfo"),o=document.getElementById("prodBodyInfo");a.innerHTML=e.orderBaseInfo(),o.innerHTML=e.prodBodyInfo(),e.othersCost(),1==e.orderInfo.vStatus?bottomBar(["share"],e.orderInfo.poManId,"","接受变更","拒绝变更"):2==e.orderInfo.vStatus?bottomBar(["share"],e.orderInfo.poManId,"","转销售变更"):bottomBar(["share"],e.orderInfo.poManId,!0),container.on("click","a.item-link",function(){var a=$(this),o=a.attr("name"),n=$body.scrollTop();switch(o){case"payInfo":orderReviseInfoCon.html(e.payInfo(n));break;case"remark":orderReviseInfoCon.html(e.remark(n))}$body.scrollTop(0),container.addClass("contarinEdit"),$("#jBottom").addClass("m-bottom-hide")}).on("click",".btn-wrap .btnB",function(){var e=$(this),a=e.attr("data-scrollTop");container.removeClass("contarinEdit"),$("#jBottom").removeClass("m-bottom-hide"),setTimeout(function(){$body.scrollTop(a)},200)}),$body.on("click",".bottom-btn-confirm",function(){return 1==e.orderInfo.vStatus?void e.receive():2==e.orderInfo.vStatus?void(window.location.href=config.htmlUrl+'customerChange_returnSale.html?param={"id":"'+_vParams.id+'","companyId":"'+_vParams.companyId+'","secretNumber":"'+_vParams.secretNumber+'","token":"'+_vParams.token+'"}'):void 0}),$body.on("click",".bottom-btn-cancel",function(){e.refuse()})},payInfo:function(e){var a=this,o=a.orderInfo,n='<ul class="payInfoList"><li><span>交易条件：</span><p>'+o.conditionName+"</p></li><li><span>物流方式：</span><p>"+enumFn(a.logisticsType,o.logisticsType)+"</p></li><li><span>"+(3==o.logisticsType?"自提点":"收货地址")+"：</span><p>"+o.provinceName+o.cityName+o.districtName+o.address+"<br>收货人："+o.contactPerson+"，电话："+o.mobile+"</p></li><li><span>付款条件：</span><p>"+o.payWayName+"</p></li><li><span>发票类型：</span><p>"+enumFn(a.invoiceType,o.invoiceType)+"</p></li><li><span>发票抬头：</span><p>"+o.invoiceHeader+"</p></li><li><span>发票类容：</span><p>"+o.invoiceContent+'</p></li></ul><div class="btn-wrap"><a href="javascript:;" class="btnB" data-scrollTop="'+e+'">完成</a></div>';return n},remark:function(e){var a=this,o='<div class="remarks-wrap"><div id="provisions" class="item-wrap clause">	<h2>补充条款：</h2>	<p>'+a.orderInfo.agreement+'</p></div><div id="taRemarks" class="item-wrap taRemarks">	<h2>备注信息：</h2>	<p>'+a.orderInfo.poRemark+'</p></div><div id="files" class="item-wrap attachment">	<h2>订单附件：</h2>';return o+='</div></div></div><div class="btn-wrap"><a href="javascript:;" id="saveRemark" class="btnB" data-scrollTop="'+e+'">完成</a></div>'},popup:function(e,a,o,n,r){new Popup({type:e,title:a,content:o,ok:"确定",cancel:"取消",closeCallBack:n,okCallBack:r})},refuse:function(){var e=this;e.popup("confirm","","您确定要拒绝变更么？<br>拒绝后的变更，将不能恢复。",function(){},function(){var a={serviceId:"B03_refusePocNotice",pocId:_vParams.id,companyId:e.orderInfo.vendorId,commonParam:commonParam(),token:_vParams.token,secretNumber:_vParams.secretNumber};GetAJAXData("POST",a,function(e){return e.success?void popup("alert","","拒绝变更成功！返回上一级",function(){},function(){goBack()}):(popup("alert","",e.errorMsg),!1)})})},receive:function(){var e=this;e.popup("confirm","","接受客户订单变更后，请即时更新本方的销售订单信息，并通知相关人员，以免发生交期延误哦！",function(){},function(){var a={serviceId:"B03_acceptPocNotice",pocId:_vParams.id,companyId:e.orderInfo.vendorId,commonParam:commonParam(),token:_vParams.token,secretNumber:_vParams.secretNumber};GetAJAXData("POST",a,function(e){return e.success?void popup("alert","","接受变更成功！返回上一级",function(){},function(){goBack()}):(popup("alert","",e.errorMsg),!1)})})}};